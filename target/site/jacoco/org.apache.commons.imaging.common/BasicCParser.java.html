<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BasicCParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons Imaging</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.imaging.common</a> &gt; <span class="el_source">BasicCParser.java</span></div><h1>BasicCParser.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.imaging.common;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PushbackInputStream;
import java.util.Map;

import org.apache.commons.imaging.ImagingException;

/**
 * A rudimentary preprocessor and parser for the C programming language.
 *
 * FIXME replace this by a parser generated via ANTLR (if we really need it?!)
 */
public class BasicCParser {
    /**
     * Parses the hexadecimal-base escape-sequence found at index {@code i} of {@code string}.
     *
     * &lt;p&gt;
     * Helper-function for {@code unescapeString()}.
     * &lt;/p&gt;
     *
     * @param i             the index of the escape-sequence in the string
     * @param stringBuilder the stringBuilder to append the escape-char to
     * @param string        the string whose chars are parsed
     * @return the new index i
     * @since 1.0-alpha3
     */
    private static int appendHex(int i, final StringBuilder stringBuilder, final String string) throws ImagingException {
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (i + 2 &gt;= string.length()) {</span>
<span class="nc" id="L49">            throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;hex constant in string too short&quot;);</span>
        }
<span class="nc" id="L51">        final char hex1 = string.charAt(i + 1);</span>
<span class="nc" id="L52">        final char hex2 = string.charAt(i + 2);</span>
<span class="nc" id="L53">        i += 2;</span>
        int constant;
        try {
<span class="nc" id="L56">            constant = Integer.parseInt(hex1 + Character.toString(hex2), 16);</span>
<span class="nc" id="L57">        } catch (final NumberFormatException nfe) {</span>
<span class="nc" id="L58">            throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;hex constant invalid&quot;, nfe);</span>
<span class="nc" id="L59">        }</span>
<span class="nc" id="L60">        stringBuilder.append((char) constant);</span>
<span class="nc" id="L61">        return i;</span>
    }

    /**
     * Parses the octal-base escape-sequence found at index {@code i} of {@code string}.
     *
     * &lt;p&gt;
     * Helper-function for {@code unescapeString()}.
     * &lt;/p&gt;
     *
     * @param i             the index of the escape-sequence in the string
     * @param stringBuilder the stringBuilder to append the escape-char to
     * @param string        the string whose chars are parsed
     * @return the new index i
     * @since 1.0-alpha3
     */
    private static int appendOct(int i, final StringBuilder stringBuilder, final String string) {
<span class="nc" id="L78">        int length = 1;</span>
<span class="nc bnc" id="L79" title="All 6 branches missed.">        if (i + 1 &lt; string.length() &amp;&amp; '0' &lt;= string.charAt(i + 1) &amp;&amp; string.charAt(i + 1) &lt;= '7') {</span>
<span class="nc" id="L80">            ++length;</span>
        }
<span class="nc bnc" id="L82" title="All 6 branches missed.">        if (i + 2 &lt; string.length() &amp;&amp; '0' &lt;= string.charAt(i + 2) &amp;&amp; string.charAt(i + 2) &lt;= '7') {</span>
<span class="nc" id="L83">            ++length;</span>
        }
<span class="nc" id="L85">        int constant = 0;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        for (int j = 0; j &lt; length; j++) {</span>
<span class="nc" id="L87">            constant *= 8;</span>
<span class="nc" id="L88">            constant += string.charAt(i + j) - '0';</span>
        }
<span class="nc" id="L90">        i += length - 1;</span>
<span class="nc" id="L91">        stringBuilder.append((char) constant);</span>
<span class="nc" id="L92">        return i;</span>
    }

    /**
     * Parses the {@code i:th} escape-char in the input {@code string} and appends it to {@code stringBuilder}.
     *
     * &lt;p&gt;
     * Helper-function for {@code unescapeString()}.
     * &lt;/p&gt;
     *
     * @param i             the index of the escape-char in the string
     * @param stringBuilder the stringBuilder to append the escape-char to
     * @param string        the string whose chars are parsed
     * @return the new index i
     * @since 1.0-alpha3
     */
    private static int parseEscape(int i, final StringBuilder stringBuilder, final String string) throws ImagingException {
<span class="nc" id="L109">        final char c = string.charAt(i);</span>
<span class="nc bnc" id="L110" title="All 13 branches missed.">        switch (c) {</span>
        case '\\':
<span class="nc" id="L112">            stringBuilder.append('\\');</span>
<span class="nc" id="L113">            break;</span>
        case '&quot;':
<span class="nc" id="L115">            stringBuilder.append('&quot;');</span>
<span class="nc" id="L116">            break;</span>
        case '\'':
<span class="nc" id="L118">            stringBuilder.append('\'');</span>
<span class="nc" id="L119">            break;</span>
        case 'x':
<span class="nc" id="L121">            i = appendHex(i, stringBuilder, string);</span>
<span class="nc" id="L122">            break;</span>
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
<span class="nc" id="L131">            i = appendOct(i, stringBuilder, string);</span>
<span class="nc" id="L132">            break;</span>
        case 'a':
<span class="nc" id="L134">            stringBuilder.append((char) 0x07);</span>
<span class="nc" id="L135">            break;</span>
        case 'b':
<span class="nc" id="L137">            stringBuilder.append((char) 0x08);</span>
<span class="nc" id="L138">            break;</span>
        case 'f':
<span class="nc" id="L140">            stringBuilder.append((char) 0x0c);</span>
<span class="nc" id="L141">            break;</span>
        case 'n':
<span class="nc" id="L143">            stringBuilder.append((char) 0x0a);</span>
<span class="nc" id="L144">            break;</span>
        case 'r':
<span class="nc" id="L146">            stringBuilder.append((char) 0x0d);</span>
<span class="nc" id="L147">            break;</span>
        case 't':
<span class="nc" id="L149">            stringBuilder.append((char) 0x09);</span>
<span class="nc" id="L150">            break;</span>
        case 'v':
<span class="nc" id="L152">            stringBuilder.append((char) 0x0b);</span>
<span class="nc" id="L153">            break;</span>
        default:
<span class="nc" id="L155">            throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;invalid escape sequence&quot;);</span>
        }
<span class="nc" id="L157">        return i;</span>

    }

    public static ByteArrayOutputStream preprocess(final InputStream is, final StringBuilder firstComment, final Map&lt;String, String&gt; defines)
            throws IOException, ImagingException {
<span class="fc" id="L163">        boolean inSingleQuotes = false;</span>
<span class="fc" id="L164">        boolean inString = false;</span>
<span class="fc" id="L165">        boolean inComment = false;</span>
<span class="fc" id="L166">        boolean inDirective = false;</span>
<span class="fc" id="L167">        boolean hadSlash = false;</span>
<span class="fc" id="L168">        boolean hadStar = false;</span>
<span class="fc" id="L169">        boolean hadBackSlash = false;</span>
<span class="fc" id="L170">        final ByteArrayOutputStream out = new ByteArrayOutputStream();</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        boolean seenFirstComment = firstComment == null;</span>
<span class="fc" id="L172">        final StringBuilder directiveBuffer = new StringBuilder();</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">        for (int c = is.read(); c != -1; c = is.read()) {</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">            if (inComment) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                if (c == '*') {</span>
<span class="pc bpc" id="L176" title="3 of 4 branches missed.">                    if (hadStar &amp;&amp; !seenFirstComment) {</span>
<span class="nc" id="L177">                        firstComment.append('*');</span>
                    }
<span class="fc" id="L179">                    hadStar = true;</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">                } else if (c == '/') {</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">                    if (hadStar) {</span>
<span class="fc" id="L182">                        hadStar = false;</span>
<span class="fc" id="L183">                        inComment = false;</span>
<span class="fc" id="L184">                        seenFirstComment = true;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    } else if (!seenFirstComment) {</span>
<span class="nc" id="L186">                        firstComment.append((char) c);</span>
                    }
                } else {
<span class="pc bpc" id="L189" title="3 of 4 branches missed.">                    if (hadStar &amp;&amp; !seenFirstComment) {</span>
<span class="nc" id="L190">                        firstComment.append('*');</span>
                    }
<span class="fc" id="L192">                    hadStar = false;</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                    if (!seenFirstComment) {</span>
<span class="fc" id="L194">                        firstComment.append((char) c);</span>
                    }
                }
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            } else if (inSingleQuotes) {</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">                switch (c) {</span>
                case '\\':
<span class="nc bnc" id="L200" title="All 2 branches missed.">                    if (hadBackSlash) {</span>
<span class="nc" id="L201">                        out.write('\\');</span>
<span class="nc" id="L202">                        out.write('\\');</span>
<span class="nc" id="L203">                        hadBackSlash = false;</span>
                    } else {
<span class="nc" id="L205">                        hadBackSlash = true;</span>
                    }
<span class="nc" id="L207">                    break;</span>
                case '\'':
<span class="nc bnc" id="L209" title="All 2 branches missed.">                    if (hadBackSlash) {</span>
<span class="nc" id="L210">                        out.write('\\');</span>
<span class="nc" id="L211">                        hadBackSlash = false;</span>
                    } else {
<span class="nc" id="L213">                        inSingleQuotes = false;</span>
                    }
<span class="nc" id="L215">                    out.write('\'');</span>
<span class="nc" id="L216">                    break;</span>
                case '\r':
                case '\n':
<span class="nc" id="L219">                    throw new ImagingException(&quot;Unterminated single quote in file&quot;);</span>
                default:
<span class="nc bnc" id="L221" title="All 2 branches missed.">                    if (hadBackSlash) {</span>
<span class="nc" id="L222">                        out.write('\\');</span>
<span class="nc" id="L223">                        hadBackSlash = false;</span>
                    }
<span class="nc" id="L225">                    out.write(c);</span>
<span class="nc" id="L226">                    break;</span>
                }
<span class="fc bfc" id="L228" title="All 2 branches covered.">            } else if (inString) {</span>
<span class="pc bpc" id="L229" title="2 of 4 branches missed.">                switch (c) {</span>
                case '\\':
<span class="nc bnc" id="L231" title="All 2 branches missed.">                    if (hadBackSlash) {</span>
<span class="nc" id="L232">                        out.write('\\');</span>
<span class="nc" id="L233">                        out.write('\\');</span>
<span class="nc" id="L234">                        hadBackSlash = false;</span>
                    } else {
<span class="nc" id="L236">                        hadBackSlash = true;</span>
                    }
<span class="nc" id="L238">                    break;</span>
                case '&quot;':
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                    if (hadBackSlash) {</span>
<span class="nc" id="L241">                        out.write('\\');</span>
<span class="nc" id="L242">                        hadBackSlash = false;</span>
                    } else {
<span class="fc" id="L244">                        inString = false;</span>
                    }
<span class="fc" id="L246">                    out.write('&quot;');</span>
<span class="fc" id="L247">                    break;</span>
                case '\r':
                case '\n':
<span class="nc" id="L250">                    throw new ImagingException(&quot;Unterminated string in file&quot;);</span>
                default:
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">                    if (hadBackSlash) {</span>
<span class="nc" id="L253">                        out.write('\\');</span>
<span class="nc" id="L254">                        hadBackSlash = false;</span>
                    }
<span class="fc" id="L256">                    out.write(c);</span>
<span class="fc" id="L257">                    break;</span>
                }
<span class="fc bfc" id="L259" title="All 2 branches covered.">            } else if (inDirective) {</span>
<span class="fc bfc" id="L260" title="All 4 branches covered.">                if (c == '\r' || c == '\n') {</span>
<span class="fc" id="L261">                    inDirective = false;</span>
<span class="fc" id="L262">                    final String[] tokens = tokenizeRow(directiveBuffer.toString());</span>
<span class="pc bpc" id="L263" title="2 of 4 branches missed.">                    if (tokens.length &lt; 2 || tokens.length &gt; 3) {</span>
<span class="nc" id="L264">                        throw new ImagingException(&quot;Bad preprocessor directive&quot;);</span>
                    }
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                    if (!tokens[0].equals(&quot;define&quot;)) {</span>
<span class="nc" id="L267">                        throw new ImagingException(&quot;Invalid/unsupported &quot; + &quot;preprocessor directive '&quot; + tokens[0] + &quot;'&quot;);</span>
                    }
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">                    defines.put(tokens[1], tokens.length == 3 ? tokens[2] : null);</span>
<span class="fc" id="L270">                    directiveBuffer.setLength(0);</span>
<span class="fc" id="L271">                } else {</span>
<span class="fc" id="L272">                    directiveBuffer.append((char) c);</span>
                }
            } else {
<span class="pc bpc" id="L275" title="1 of 6 branches missed.">                switch (c) {</span>
                case '/':
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">                    if (hadSlash) {</span>
<span class="nc" id="L278">                        out.write('/');</span>
                    }
<span class="fc" id="L280">                    hadSlash = true;</span>
<span class="fc" id="L281">                    break;</span>
                case '*':
<span class="fc bfc" id="L283" title="All 2 branches covered.">                    if (hadSlash) {</span>
<span class="fc" id="L284">                        inComment = true;</span>
<span class="fc" id="L285">                        hadSlash = false;</span>
                    } else {
<span class="fc" id="L287">                        out.write(c);</span>
                    }
<span class="fc" id="L289">                    break;</span>
                case '\'':
<span class="nc bnc" id="L291" title="All 2 branches missed.">                    if (hadSlash) {</span>
<span class="nc" id="L292">                        out.write('/');</span>
                    }
<span class="nc" id="L294">                    hadSlash = false;</span>
<span class="nc" id="L295">                    out.write(c);</span>
<span class="nc" id="L296">                    inSingleQuotes = true;</span>
<span class="nc" id="L297">                    break;</span>
                case '&quot;':
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">                    if (hadSlash) {</span>
<span class="nc" id="L300">                        out.write('/');</span>
                    }
<span class="fc" id="L302">                    hadSlash = false;</span>
<span class="fc" id="L303">                    out.write(c);</span>
<span class="fc" id="L304">                    inString = true;</span>
<span class="fc" id="L305">                    break;</span>
                case '#':
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">                    if (defines == null) {</span>
<span class="nc" id="L308">                        throw new ImagingException(&quot;Unexpected preprocessor directive&quot;);</span>
                    }
<span class="fc" id="L310">                    inDirective = true;</span>
<span class="fc" id="L311">                    break;</span>
                default:
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">                    if (hadSlash) {</span>
<span class="nc" id="L314">                        out.write('/');</span>
                    }
<span class="fc" id="L316">                    hadSlash = false;</span>
<span class="fc" id="L317">                    out.write(c);</span>
                    // Only whitespace allowed before first comment:
<span class="pc bpc" id="L319" title="1 of 8 branches missed.">                    if (c != ' ' &amp;&amp; c != '\t' &amp;&amp; c != '\r' &amp;&amp; c != '\n') {</span>
<span class="fc" id="L320">                        seenFirstComment = true;</span>
                    }
                    break;
                }
            }
        }
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">        if (hadSlash) {</span>
<span class="nc" id="L327">            out.write('/');</span>
        }
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">        if (hadStar) {</span>
<span class="nc" id="L330">            out.write('*');</span>
        }
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (inString) {</span>
<span class="nc" id="L333">            throw new ImagingException(&quot;Unterminated string at the end of file&quot;);</span>
        }
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        if (inComment) {</span>
<span class="nc" id="L336">            throw new ImagingException(&quot;Unterminated comment at the end of file&quot;);</span>
        }
<span class="fc" id="L338">        return out;</span>
    }

    public static String[] tokenizeRow(final String row) {
<span class="fc" id="L342">        final String[] tokens = row.split(&quot;[ \t]&quot;);</span>
<span class="fc" id="L343">        int numLiveTokens = 0;</span>
<span class="fc bfc" id="L344" title="All 2 branches covered.">        for (final String token : tokens) {</span>
<span class="pc bpc" id="L345" title="1 of 4 branches missed.">            if (token != null &amp;&amp; !token.isEmpty()) {</span>
<span class="fc" id="L346">                ++numLiveTokens;</span>
            }
        }
<span class="fc" id="L349">        final String[] liveTokens = Allocator.array(numLiveTokens, String[]::new, 24);</span>
<span class="fc" id="L350">        int next = 0;</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">        for (final String token : tokens) {</span>
<span class="pc bpc" id="L352" title="1 of 4 branches missed.">            if (token != null &amp;&amp; !token.isEmpty()) {</span>
<span class="fc" id="L353">                liveTokens[next++] = token;</span>
            }
        }
<span class="fc" id="L356">        return liveTokens;</span>
    }

    public static void unescapeString(final StringBuilder stringBuilder, final String string) throws ImagingException {
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">        if (string.length() &lt; 2) {</span>
<span class="nc" id="L361">            throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;string is too short&quot;);</span>
        }
<span class="pc bpc" id="L363" title="2 of 4 branches missed.">        if (string.charAt(0) != '&quot;' || string.charAt(string.length() - 1) != '&quot;') {</span>
<span class="nc" id="L364">            throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;string not surrounded by '\&quot;'&quot;);</span>
        }
<span class="fc" id="L366">        boolean hadBackSlash = false;</span>
<span class="fc bfc" id="L367" title="All 2 branches covered.">        for (int i = 1; i &lt; string.length() - 1; i++) {</span>
<span class="fc" id="L368">            final char c = string.charAt(i);</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">            if (hadBackSlash) {</span>
<span class="nc" id="L370">                i = parseEscape(i, stringBuilder, string);</span>
<span class="nc" id="L371">                hadBackSlash = false;</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">            } else if (c == '\\') {</span>
<span class="nc" id="L373">                hadBackSlash = true;</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">            } else if (c == '&quot;') {</span>
<span class="nc" id="L375">                throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;extra '\&quot;' found in string&quot;);</span>
            } else {
<span class="fc" id="L377">                stringBuilder.append(c);</span>
            }
        }
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">        if (hadBackSlash) {</span>
<span class="nc" id="L381">            throw new ImagingException(&quot;Parsing XPM file failed, &quot; + &quot;unterminated escape sequence found in string&quot;);</span>
        }
<span class="fc" id="L383">    }</span>

    private final PushbackInputStream is;

<span class="fc" id="L387">    public BasicCParser(final ByteArrayInputStream is) {</span>
<span class="fc" id="L388">        this.is = new PushbackInputStream(is);</span>
<span class="fc" id="L389">    }</span>

    public String nextToken() throws IOException, ImagingException {
        // I don't know how complete the C parsing in an XPM file
        // is meant to be, this is just the very basics...

<span class="fc" id="L395">        boolean inString = false;</span>
<span class="fc" id="L396">        boolean inIdentifier = false;</span>
<span class="fc" id="L397">        boolean hadBackSlash = false;</span>
<span class="fc" id="L398">        final StringBuilder token = new StringBuilder();</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">        for (int c = is.read(); c != -1; c = is.read()) {</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">            if (inString) {</span>
<span class="pc bpc" id="L401" title="2 of 4 branches missed.">                switch (c) {</span>
                case '\\':
<span class="nc" id="L403">                    token.append('\\');</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                    hadBackSlash = !hadBackSlash;</span>
<span class="nc" id="L405">                    break;</span>
                case '&quot;':
<span class="fc" id="L407">                    token.append('&quot;');</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">                    if (!hadBackSlash) {</span>
<span class="fc" id="L409">                        return token.toString();</span>
                    }
<span class="nc" id="L411">                    hadBackSlash = false;</span>
<span class="nc" id="L412">                    break;</span>
                case '\r':
                case '\n':
<span class="nc" id="L415">                    throw new ImagingException(&quot;Unterminated string in XPM file&quot;);</span>
                default:
<span class="fc" id="L417">                    token.append((char) c);</span>
<span class="fc" id="L418">                    hadBackSlash = false;</span>
<span class="fc" id="L419">                    break;</span>
                }
<span class="fc bfc" id="L421" title="All 2 branches covered.">            } else if (inIdentifier) {</span>
<span class="fc bfc" id="L422" title="All 4 branches covered.">                if (!Character.isLetterOrDigit(c) &amp;&amp; c != '_') {</span>
<span class="fc" id="L423">                    is.unread(c);</span>
<span class="fc" id="L424">                    return token.toString();</span>
                }
<span class="fc" id="L426">                token.append((char) c);</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">            } else if (c == '&quot;') {</span>
<span class="fc" id="L428">                token.append('&quot;');</span>
<span class="fc" id="L429">                inString = true;</span>
<span class="pc bpc" id="L430" title="1 of 4 branches missed.">            } else if (Character.isLetterOrDigit(c) || c == '_') {</span>
<span class="fc" id="L431">                token.append((char) c);</span>
<span class="fc" id="L432">                inIdentifier = true;</span>
<span class="fc bfc" id="L433" title="All 16 branches covered.">            } else if (c == '{' || c == '}' || c == '[' || c == ']' || c == '*' || c == ';' || c == '=' || c == ',') {</span>
<span class="fc" id="L434">                token.append((char) c);</span>
<span class="fc" id="L435">                return token.toString();</span>
<span class="pc bpc" id="L436" title="2 of 8 branches missed.">            } else if (c == ' ' || c == '\t' || c == '\r' || c == '\n') { // NOPMD</span>
                // ignore
            } else {
<span class="nc" id="L439">                throw new ImagingException(&quot;Unhandled/invalid character '&quot; + (char) c + &quot;' found in XPM file&quot;);</span>
            }
        }

<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (inIdentifier) {</span>
<span class="nc" id="L444">            return token.toString();</span>
        }
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (inString) {</span>
<span class="nc" id="L447">            throw new ImagingException(&quot;Unterminated string ends XMP file&quot;);</span>
        }
<span class="nc" id="L449">        return null;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>