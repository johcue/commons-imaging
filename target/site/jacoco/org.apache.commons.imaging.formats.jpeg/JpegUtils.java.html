<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JpegUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons Imaging</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.imaging.formats.jpeg</a> &gt; <span class="el_source">JpegUtils.java</span></div><h1>JpegUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.imaging.formats.jpeg;

import java.io.IOException;
import java.io.InputStream;
import java.nio.ByteOrder;

import org.apache.commons.imaging.ImagingException;
import org.apache.commons.imaging.bytesource.ByteSource;
import org.apache.commons.imaging.common.BinaryFileParser;
import org.apache.commons.imaging.common.BinaryFunctions;
import org.apache.commons.imaging.common.ByteConversions;
import org.apache.commons.imaging.internal.Debug;
import org.apache.commons.io.IOUtils;

public class JpegUtils extends BinaryFileParser {
    public interface Visitor {
        // return false to exit before reading image data.
        boolean beginSos();

        // return false to exit traversal.
        boolean visitSegment(int marker, byte[] markerBytes, int segmentLength, byte[] segmentLengthBytes, byte[] segmentData)
                throws ImagingException, IOException;

        void visitSos(int marker, byte[] markerBytes, byte[] imageData);
    }

    public static String getMarkerName(final int marker) {
<span class="pc bpc" id="L44" title="23 of 34 branches missed.">        switch (marker) {</span>
        case JpegConstants.SOS_MARKER:
<span class="nc" id="L46">            return &quot;SOS_MARKER&quot;;</span>
        // case JPEG_APP0 :
        // return &quot;JPEG_APP0&quot;;
        // case JPEG_APP0_MARKER :
        // return &quot;JPEG_APP0_MARKER&quot;;
        case JpegConstants.JPEG_APP1_MARKER:
<span class="fc" id="L52">            return &quot;JPEG_APP1_MARKER&quot;;</span>
        case JpegConstants.JPEG_APP2_MARKER:
<span class="fc" id="L54">            return &quot;JPEG_APP2_MARKER&quot;;</span>
        case JpegConstants.JPEG_APP13_MARKER:
<span class="fc" id="L56">            return &quot;JPEG_APP13_MARKER&quot;;</span>
        case JpegConstants.JPEG_APP14_MARKER:
<span class="fc" id="L58">            return &quot;JPEG_APP14_MARKER&quot;;</span>
        case JpegConstants.JPEG_APP15_MARKER:
<span class="nc" id="L60">            return &quot;JPEG_APP15_MARKER&quot;;</span>
        case JpegConstants.JFIF_MARKER:
<span class="fc" id="L62">            return &quot;JFIF_MARKER&quot;;</span>
        case JpegConstants.SOF0_MARKER:
<span class="fc" id="L64">            return &quot;SOF0_MARKER&quot;;</span>
        case JpegConstants.SOF1_MARKER:
<span class="nc" id="L66">            return &quot;SOF1_MARKER&quot;;</span>
        case JpegConstants.SOF2_MARKER:
<span class="fc" id="L68">            return &quot;SOF2_MARKER&quot;;</span>
        case JpegConstants.SOF3_MARKER:
<span class="nc" id="L70">            return &quot;SOF3_MARKER&quot;;</span>
        case JpegConstants.DHT_MARKER:
<span class="fc" id="L72">            return &quot;SOF4_MARKER&quot;;</span>
        case JpegConstants.SOF5_MARKER:
<span class="nc" id="L74">            return &quot;SOF5_MARKER&quot;;</span>
        case JpegConstants.SOF6_MARKER:
<span class="nc" id="L76">            return &quot;SOF6_MARKER&quot;;</span>
        case JpegConstants.SOF7_MARKER:
<span class="nc" id="L78">            return &quot;SOF7_MARKER&quot;;</span>
        case JpegConstants.SOF8_MARKER:
<span class="nc" id="L80">            return &quot;SOF8_MARKER&quot;;</span>
        case JpegConstants.SOF9_MARKER:
<span class="nc" id="L82">            return &quot;SOF9_MARKER&quot;;</span>
        case JpegConstants.SOF10_MARKER:
<span class="nc" id="L84">            return &quot;SOF10_MARKER&quot;;</span>
        case JpegConstants.SOF11_MARKER:
<span class="nc" id="L86">            return &quot;SOF11_MARKER&quot;;</span>
        case JpegConstants.DAC_MARKER:
<span class="nc" id="L88">            return &quot;DAC_MARKER&quot;;</span>
        case JpegConstants.SOF13_MARKER:
<span class="nc" id="L90">            return &quot;SOF13_MARKER&quot;;</span>
        case JpegConstants.SOF14_MARKER:
<span class="nc" id="L92">            return &quot;SOF14_MARKER&quot;;</span>
        case JpegConstants.SOF15_MARKER:
<span class="nc" id="L94">            return &quot;SOF15_MARKER&quot;;</span>
        case JpegConstants.DQT_MARKER:
<span class="fc" id="L96">            return &quot;DQT_MARKER&quot;;</span>
        case JpegConstants.DRI_MARKER:
<span class="fc" id="L98">            return &quot;DRI_MARKER&quot;;</span>
        case JpegConstants.RST0_MARKER:
<span class="nc" id="L100">            return &quot;RST0_MARKER&quot;;</span>
        case JpegConstants.RST1_MARKER:
<span class="nc" id="L102">            return &quot;RST1_MARKER&quot;;</span>
        case JpegConstants.RST2_MARKER:
<span class="nc" id="L104">            return &quot;RST2_MARKER&quot;;</span>
        case JpegConstants.RST3_MARKER:
<span class="nc" id="L106">            return &quot;RST3_MARKER&quot;;</span>
        case JpegConstants.RST4_MARKER:
<span class="nc" id="L108">            return &quot;RST4_MARKER&quot;;</span>
        case JpegConstants.RST5_MARKER:
<span class="nc" id="L110">            return &quot;RST5_MARKER&quot;;</span>
        case JpegConstants.RST6_MARKER:
<span class="nc" id="L112">            return &quot;RST6_MARKER&quot;;</span>
        case JpegConstants.RST7_MARKER:
<span class="nc" id="L114">            return &quot;RST7_MARKER&quot;;</span>
        default:
<span class="fc" id="L116">            return &quot;Unknown&quot;;</span>
        }
    }

    public JpegUtils() {
<span class="fc" id="L121">        super(ByteOrder.BIG_ENDIAN);</span>
<span class="fc" id="L122">    }</span>

    public void dumpJfif(final ByteSource byteSource) throws ImagingException, IOException {
<span class="fc" id="L125">        final Visitor visitor = new Visitor() {</span>
            // return false to exit before reading image data.
            @Override
            public boolean beginSos() {
<span class="fc" id="L129">                return true;</span>
            }

            // return false to exit traversal.
            @Override
            public boolean visitSegment(final int marker, final byte[] markerBytes, final int segmentLength, final byte[] segmentLengthBytes,
                    final byte[] segmentData) {
<span class="fc" id="L136">                Debug.debug(&quot;Segment marker: &quot; + Integer.toHexString(marker) + &quot; (&quot; + getMarkerName(marker) + &quot;), &quot; + segmentData.length</span>
                        + &quot; bytes of segment data.&quot;);
<span class="fc" id="L138">                return true;</span>
            }

            @Override
            public void visitSos(final int marker, final byte[] markerBytes, final byte[] imageData) {
<span class="fc" id="L143">                Debug.debug(&quot;SOS marker.  &quot; + imageData.length + &quot; bytes of image data.&quot;);</span>
<span class="fc" id="L144">                Debug.debug(&quot;&quot;);</span>
<span class="fc" id="L145">            }</span>
        };

<span class="fc" id="L148">        traverseJfif(byteSource, visitor);</span>
<span class="fc" id="L149">    }</span>

    public void traverseJfif(final ByteSource byteSource, final Visitor visitor) throws ImagingException, IOException {
<span class="fc" id="L152">        try (InputStream is = byteSource.getInputStream()) {</span>
<span class="fc" id="L153">            BinaryFunctions.readAndVerifyBytes(is, JpegConstants.SOI, &quot;Not a Valid JPEG File: doesn't begin with 0xffd8&quot;);</span>

            int markerCount;
<span class="fc" id="L156">            for (markerCount = 0; true; markerCount++) {</span>
<span class="fc" id="L157">                final byte[] markerBytes = new byte[2];</span>
                do {
<span class="fc" id="L159">                    markerBytes[0] = markerBytes[1];</span>
<span class="fc" id="L160">                    markerBytes[1] = BinaryFunctions.readByte(&quot;marker&quot;, is, &quot;Could not read marker&quot;);</span>
<span class="fc bfc" id="L161" title="All 4 branches covered.">                } while ((0xff &amp; markerBytes[0]) != 0xff || (0xff &amp; markerBytes[1]) == 0xff);</span>
<span class="fc" id="L162">                final int marker = (0xff &amp; markerBytes[0]) &lt;&lt; 8 | 0xff &amp; markerBytes[1];</span>

<span class="pc bpc" id="L164" title="1 of 4 branches missed.">                if (marker == JpegConstants.EOI_MARKER || marker == JpegConstants.SOS_MARKER) {</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">                    if (!visitor.beginSos()) {</span>
<span class="fc" id="L166">                        return;</span>
                    }

<span class="fc" id="L169">                    final byte[] imageData = IOUtils.toByteArray(is);</span>
<span class="fc" id="L170">                    visitor.visitSos(marker, markerBytes, imageData);</span>
<span class="fc" id="L171">                    break;</span>
                }

<span class="fc" id="L174">                final byte[] segmentLengthBytes = BinaryFunctions.readBytes(&quot;segmentLengthBytes&quot;, is, 2, &quot;segmentLengthBytes&quot;);</span>
<span class="fc" id="L175">                final int segmentLength = ByteConversions.toUInt16(segmentLengthBytes, getByteOrder());</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">                if (segmentLength &lt; 2) {</span>
<span class="fc" id="L177">                    throw new ImagingException(&quot;Invalid segment size&quot;);</span>
                }

<span class="fc" id="L180">                final byte[] segmentData = BinaryFunctions.readBytes(&quot;Segment Data&quot;, is, segmentLength - 2, &quot;Invalid Segment: insufficient data&quot;);</span>

<span class="fc bfc" id="L182" title="All 2 branches covered.">                if (!visitor.visitSegment(marker, markerBytes, segmentLength, segmentLengthBytes, segmentData)) {</span>
<span class="fc" id="L183">                    return;</span>
                }
            }

<span class="fc" id="L187">            Debug.debug(markerCount + &quot; markers&quot;);</span>
<span class="pc bpc" id="L188" title="2 of 4 branches missed.">        }</span>
<span class="fc" id="L189">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>