<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ColorConversions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons Imaging</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.imaging.color</a> &gt; <span class="el_source">ColorConversions.java</span></div><h1>ColorConversions.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.imaging.color;

public final class ColorConversions {

    // White reference
    /** See: https://en.wikipedia.org/wiki/CIELAB_color_space#From_CIEXYZ_to_CIELAB[10] */
    private static final double REF_X = 95.047; // Observer= 2°, Illuminant= D65

    /** See: https://en.wikipedia.org/wiki/CIELAB_color_space#From_CIEXYZ_to_CIELAB[10] */
    private static final double REF_Y = 100.000;

    /** See: https://en.wikipedia.org/wiki/CIELAB_color_space#From_CIEXYZ_to_CIELAB[10] */
    private static final double REF_Z = 108.883;

    /** See: https://en.wikipedia.org/wiki/CIELAB_color_space#From_CIEXYZ_to_CIELAB[10] */
    private static final double XYZ_m = 7.787037; // match in slope. Note commonly seen 7.787 gives worse results

    /** See: https://en.wikipedia.org/wiki/CIELAB_color_space#From_CIEXYZ_to_CIELAB[10] */
    private static final double XYZ_t0 = 0.008856;

    public static int convertCieLabToArgbTest(final int cieL, final int cieA, final int cieB) {
        double x, y, z;
        {

<span class="nc" id="L41">            double varY = (cieL * 100.0 / 255.0 + 16.0) / 116.0;</span>
<span class="nc" id="L42">            double varX = cieA / 500.0 + varY;</span>
<span class="nc" id="L43">            double varZ = varY - cieB / 200.0;</span>

<span class="nc" id="L45">            varX = unPivotXyz(varX);</span>
<span class="nc" id="L46">            varY = unPivotXyz(varY);</span>
<span class="nc" id="L47">            varZ = unPivotXyz(varZ);</span>

<span class="nc" id="L49">            x = REF_X * varX; // REF_X = 95.047 Observer= 2°, Illuminant= D65</span>
<span class="nc" id="L50">            y = REF_Y * varY; // REF_Y = 100.000</span>
<span class="nc" id="L51">            z = REF_Z * varZ; // REF_Z = 108.883</span>

        }

        double r, g, b;
        {
<span class="nc" id="L57">            final double varX = x / 100; // X = From 0 to REF_X</span>
<span class="nc" id="L58">            final double varY = y / 100; // Y = From 0 to REF_Y</span>
<span class="nc" id="L59">            final double varZ = z / 100; // Z = From 0 to REF_Y</span>

<span class="nc" id="L61">            double varR = varX * 3.2406 + varY * -1.5372 + varZ * -0.4986;</span>
<span class="nc" id="L62">            double varG = varX * -0.9689 + varY * 1.8758 + varZ * 0.0415;</span>
<span class="nc" id="L63">            double varB = varX * 0.0557 + varY * -0.2040 + varZ * 1.0570;</span>

<span class="nc" id="L65">            varR = pivotRgb(varR);</span>
<span class="nc" id="L66">            varG = pivotRgb(varG);</span>
<span class="nc" id="L67">            varB = pivotRgb(varB);</span>

<span class="nc" id="L69">            r = varR * 255;</span>
<span class="nc" id="L70">            g = varG * 255;</span>
<span class="nc" id="L71">            b = varB * 255;</span>
        }

<span class="nc" id="L74">        return convertRgbToRgb(r, g, b);</span>
    }

    public static ColorCieLch convertCieLabToCieLch(final ColorCieLab cielab) {
<span class="fc" id="L78">        return convertCieLabToCieLch(cielab.l, cielab.a, cielab.b);</span>
    }

    public static ColorCieLch convertCieLabToCieLch(final double l, final double a, final double b) {
        // atan2(y,x) returns atan(y/x)
<span class="fc" id="L83">        final double atanba = Math.atan2(b, a); // Quadrant by signs</span>

<span class="fc bfc" id="L85" title="All 2 branches covered.">        final double h = atanba &gt; 0 //</span>
<span class="fc" id="L86">                ? Math.toDegrees(atanba) //</span>
<span class="fc" id="L87">                : Math.toDegrees(atanba) + 360;</span>

        // L = L;
<span class="fc" id="L90">        final double C = Math.sqrt(square(a) + square(b));</span>

<span class="fc" id="L92">        return new ColorCieLch(l, C, h);</span>
    }

    public static ColorDin99Lab convertCieLabToDin99bLab(final ColorCieLab cie) {
<span class="fc" id="L96">        return convertCieLabToDin99bLab(cie.l, cie.a, cie.b);</span>
    }

    public static ColorDin99Lab convertCieLabToDin99bLab(final double l, final double a, final double b) {
<span class="fc" id="L100">        final double fac1 = 100.0 / Math.log(129.0 / 50.0); // = 105.51</span>
<span class="fc" id="L101">        final double kE = 1.0; // brightness factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L102">        final double kCH = 1.0; // chroma and hue factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L103">        final double ang = Math.toRadians(16.0);</span>

<span class="fc" id="L105">        final double l99 = kE * fac1 * Math.log(1. + 0.0158 * l);</span>
<span class="fc" id="L106">        double a99 = 0.0;</span>
<span class="fc" id="L107">        double b99 = 0.0;</span>
<span class="pc bpc" id="L108" title="1 of 4 branches missed.">        if (a != 0.0 || b != 0.0) {</span>
<span class="fc" id="L109">            final double e = a * Math.cos(ang) + b * Math.sin(ang);</span>
<span class="fc" id="L110">            final double f = 0.7 * (b * Math.cos(ang) - a * Math.sin(ang));</span>
<span class="fc" id="L111">            final double G = Math.sqrt(e * e + f * f);</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">            if (G != 0.) {</span>
<span class="fc" id="L113">                final double k = Math.log(1. + 0.045 * G) / (0.045 * kCH * kE * G);</span>
<span class="fc" id="L114">                a99 = k * e;</span>
<span class="fc" id="L115">                b99 = k * f;</span>
            }
        }
<span class="fc" id="L118">        return new ColorDin99Lab(l99, a99, b99);</span>
    }

    /**
     * DIN99o.
     *
     * @param cie CIE color.
     * @return CIELab colors converted to DIN99oLab color space.
     * @see &lt;a href=
     *      &quot;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&quot;&gt;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&lt;/a&gt;
     */
    public static ColorDin99Lab convertCieLabToDin99oLab(final ColorCieLab cie) {
<span class="fc" id="L130">        return convertCieLabToDin99oLab(cie.l, cie.a, cie.b);</span>
    }

    /**
     * DIN99o.
     *
     * @param l lightness of color.
     * @param a position between red and green.
     * @param b position between yellow and blue.
     * @return CIBELab colors converted to DIN99oLab color space.
     * @see &lt;a href=
     *      &quot;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&quot;&gt;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&lt;/a&gt;
     */
    public static ColorDin99Lab convertCieLabToDin99oLab(final double l, final double a, final double b) {
<span class="fc" id="L144">        final double kE = 1.0; // brightness factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L145">        final double kCH = 1.0; // chroma and hue factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L146">        final double fac1 = 100.0 / Math.log(139.0 / 100.0); // L99 scaling factor = 303.67100547050995</span>
<span class="fc" id="L147">        final double ang = Math.toRadians(26.0);</span>

<span class="fc" id="L149">        final double l99o = fac1 / kE * Math.log(1 + 0.0039 * l); // Lightness correction kE</span>
<span class="fc" id="L150">        double a99o = 0.0;</span>
<span class="fc" id="L151">        double b99o = 0.0;</span>
<span class="pc bpc" id="L152" title="1 of 4 branches missed.">        if (a != 0.0 || b != 0.0) {</span>
<span class="fc" id="L153">            final double eo = a * Math.cos(ang) + b * Math.sin(ang); // a stretching</span>
<span class="fc" id="L154">            final double fo = 0.83 * (b * Math.cos(ang) - a * Math.sin(ang)); // b rotation/stretching</span>
<span class="fc" id="L155">            final double Go = Math.sqrt(eo * eo + fo * fo); // chroma</span>
<span class="fc" id="L156">            final double C99o = Math.log(1.0 + 0.075 * Go) / (0.0435 * kCH * kE); // factor for chroma compression and viewing conditions</span>
<span class="fc" id="L157">            final double heofo = Math.atan2(fo, eo); // arctan in four quadrants</span>
<span class="fc" id="L158">            final double h99o = heofo + ang; // hue rotation</span>
<span class="fc" id="L159">            a99o = C99o * Math.cos(h99o);</span>
<span class="fc" id="L160">            b99o = C99o * Math.sin(h99o);</span>
        }
<span class="fc" id="L162">        return new ColorDin99Lab(l99o, a99o, b99o);</span>
    }

    public static ColorXyz convertCieLabToXyz(final ColorCieLab cielab) {
<span class="fc" id="L166">        return convertCieLabToXyz(cielab.l, cielab.a, cielab.b);</span>
    }

    public static ColorXyz convertCieLabToXyz(final double l, final double a, final double b) {
<span class="fc" id="L170">        double varY = (l + 16) / 116.0;</span>
<span class="fc" id="L171">        double varX = a / 500 + varY;</span>
<span class="fc" id="L172">        double varZ = varY - b / 200.0;</span>

<span class="fc" id="L174">        varY = unPivotXyz(varY);</span>
<span class="fc" id="L175">        varX = unPivotXyz(varX);</span>
<span class="fc" id="L176">        varZ = unPivotXyz(varZ);</span>

<span class="fc" id="L178">        final double x = REF_X * varX; // REF_X = 95.047 Observer= 2°, Illuminant=</span>
        // D65
<span class="fc" id="L180">        final double y = REF_Y * varY; // REF_Y = 100.000</span>
<span class="fc" id="L181">        final double z = REF_Z * varZ; // REF_Z = 108.883</span>

<span class="fc" id="L183">        return new ColorXyz(x, y, z);</span>
    }

    public static ColorCieLab convertCieLchToCieLab(final ColorCieLch cielch) {
<span class="fc" id="L187">        return convertCieLchToCieLab(cielch.l, cielch.c, cielch.h);</span>
    }

    public static ColorCieLab convertCieLchToCieLab(final double l, final double c, final double h) {
        // Where CIE-H° = 0 ÷ 360°

        // CIE-L* = CIE-L;
<span class="fc" id="L194">        final double a = Math.cos(degree2radian(h)) * c;</span>
<span class="fc" id="L195">        final double b = Math.sin(degree2radian(h)) * c;</span>

<span class="fc" id="L197">        return new ColorCieLab(l, a, b);</span>
    }

    public static ColorXyz convertCieLuvToXyz(final ColorCieLuv cielch) {
<span class="fc" id="L201">        return convertCieLuvToXyz(cielch.l, cielch.u, cielch.v);</span>
    }

    public static ColorXyz convertCieLuvToXyz(final double l, final double u, final double v) {
        // problems here with div by zero

<span class="fc" id="L207">        double varY = (l + 16) / 116.0;</span>
<span class="fc" id="L208">        varY = unPivotXyz(varY);</span>

<span class="fc" id="L210">        final double refU = 4 * REF_X / (REF_X + 15 * REF_Y + 3 * REF_Z);</span>
<span class="fc" id="L211">        final double refV = 9 * REF_Y / (REF_X + 15 * REF_Y + 3 * REF_Z);</span>
<span class="fc" id="L212">        final double varU = u / (13 * l) + refU;</span>
<span class="fc" id="L213">        final double varV = v / (13 * l) + refV;</span>

<span class="fc" id="L215">        final double y = varY * 100;</span>
<span class="fc" id="L216">        final double x = -(9 * y * varU) / ((varU - 4) * varV - varU * varV);</span>
<span class="fc" id="L217">        final double z = (9 * y - 15 * varV * y - varV * x) / (3 * varV);</span>

<span class="fc" id="L219">        return new ColorXyz(x, y, z);</span>
    }

    public static ColorCmy convertCmykToCmy(final ColorCmyk cmyk) {
<span class="fc" id="L223">        return convertCmykToCmy(cmyk.c, cmyk.m, cmyk.y, cmyk.k);</span>
    }

    public static ColorCmy convertCmykToCmy(double c, double m, double y, final double k) {
        // Where CMYK and CMY values = 0 ÷ 1

<span class="fc" id="L229">        c = c * (1 - k) + k;</span>
<span class="fc" id="L230">        m = m * (1 - k) + k;</span>
<span class="fc" id="L231">        y = y * (1 - k) + k;</span>

<span class="fc" id="L233">        return new ColorCmy(c, m, y);</span>
    }

    public static int convertCmykToRgb(final int c, final int m, final int y, final int k) {
<span class="fc" id="L237">        final double C = c / 255.0;</span>
<span class="fc" id="L238">        final double M = m / 255.0;</span>
<span class="fc" id="L239">        final double Y = y / 255.0;</span>
<span class="fc" id="L240">        final double K = k / 255.0;</span>

<span class="fc" id="L242">        return convertCmyToRgb(convertCmykToCmy(C, M, Y, K));</span>
    }

    public static int convertCmykToRgbAdobe(final int sc, final int sm, final int sy, final int sk) {
<span class="nc" id="L246">        final int red = 255 - (sc + sk);</span>
<span class="nc" id="L247">        final int green = 255 - (sm + sk);</span>
<span class="nc" id="L248">        final int blue = 255 - (sy + sk);</span>

<span class="nc" id="L250">        return convertRgbToRgb(red, green, blue);</span>
    }

    public static ColorCmyk convertCmyToCmyk(final ColorCmy cmy) {
        // Where CMYK and CMY values = 0 ÷ 1

<span class="fc" id="L256">        double c = cmy.c;</span>
<span class="fc" id="L257">        double m = cmy.m;</span>
<span class="fc" id="L258">        double y = cmy.y;</span>

<span class="fc" id="L260">        double varK = 1.0;</span>

<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (c &lt; varK) {</span>
<span class="fc" id="L263">            varK = c;</span>
        }
<span class="fc bfc" id="L265" title="All 2 branches covered.">        if (m &lt; varK) {</span>
<span class="fc" id="L266">            varK = m;</span>
        }
<span class="fc bfc" id="L268" title="All 2 branches covered.">        if (y &lt; varK) {</span>
<span class="fc" id="L269">            varK = y;</span>
        }
<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (varK == 1) { // Black</span>
<span class="fc" id="L272">            c = 0;</span>
<span class="fc" id="L273">            m = 0;</span>
<span class="fc" id="L274">            y = 0;</span>
        } else {
<span class="fc" id="L276">            c = (c - varK) / (1 - varK);</span>
<span class="fc" id="L277">            m = (m - varK) / (1 - varK);</span>
<span class="fc" id="L278">            y = (y - varK) / (1 - varK);</span>
        }
<span class="fc" id="L280">        return new ColorCmyk(c, m, y, varK);</span>
    }

    public static int convertCmyToRgb(final ColorCmy cmy) {
        // From Ghostscript's gdevcdj.c:
        // * Ghostscript: R = (1.0 - C) * (1.0 - K)
        // * Adobe: R = 1.0 - min(1.0, C + K)
        // and similarly for G and B.
        // This is Ghostscript's formula with K = 0.

        // CMY values = 0 ÷ 1
        // RGB values = 0 ÷ 255

<span class="fc" id="L293">        final double r = (1 - cmy.c) * 255.0;</span>
<span class="fc" id="L294">        final double g = (1 - cmy.m) * 255.0;</span>
<span class="fc" id="L295">        final double b = (1 - cmy.y) * 255.0;</span>

<span class="fc" id="L297">        return convertRgbToRgb(r, g, b);</span>
    }

    public static ColorCieLab convertDin99bLabToCieLab(final ColorDin99Lab dinb) {
<span class="fc" id="L301">        return convertDin99bLabToCieLab(dinb.l99, dinb.a99, dinb.b99);</span>
    }

    public static ColorCieLab convertDin99bLabToCieLab(final double L99b, final double a99b, final double b99b) {
<span class="fc" id="L305">        final double kE = 1.0; // brightness factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L306">        final double kCH = 1.0; // chroma and hue factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L307">        final double fac1 = 100.0 / Math.log(129.0 / 50.0); // L99 scaling factor = 105.50867113783109</span>
<span class="fc" id="L308">        final double ang = Math.toRadians(16.0);</span>

<span class="fc" id="L310">        final double hef = Math.atan2(b99b, a99b);</span>
<span class="fc" id="L311">        final double c = Math.sqrt(a99b * a99b + b99b * b99b);</span>
<span class="fc" id="L312">        final double g = (Math.exp(0.045 * c * kCH * kE) - 1.0) / 0.045;</span>
<span class="fc" id="L313">        final double e = g * Math.cos(hef);</span>
<span class="fc" id="L314">        final double f = g * Math.sin(hef) / 0.7;</span>

<span class="fc" id="L316">        final double l = (Math.exp(L99b * kE / fac1) - 1.) / 0.0158;</span>
<span class="fc" id="L317">        final double a = e * Math.cos(ang) - f * Math.sin(ang);</span>
<span class="fc" id="L318">        final double b = e * Math.sin(ang) + f * Math.cos(ang);</span>
<span class="fc" id="L319">        return new ColorCieLab(l, a, b);</span>
    }

    /**
     * DIN99o.
     *
     * @param dino color in the DIN99 color space.
     * @return DIN99o colors converted to CIELab color space.
     * @see &lt;a href=
     *      &quot;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&quot;&gt;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&lt;/a&gt;
     */
    public static ColorCieLab convertDin99oLabToCieLab(final ColorDin99Lab dino) {
<span class="fc" id="L331">        return convertDin99oLabToCieLab(dino.l99, dino.a99, dino.b99);</span>
    }

    /**
     * DIN99o.
     *
     * @param l99o lightness of color.
     * @param a99o position between red and green.
     * @param b99o position between yellow and blue.
     * @return DIN99o colors converted to CIELab color space.
     * @see &lt;a href=
     *      &quot;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&quot;&gt;https://de.wikipedia.org/w/index.php?title=Diskussion:DIN99-Farbraum&lt;/a&gt;
     */
    public static ColorCieLab convertDin99oLabToCieLab(final double l99o, final double a99o, final double b99o) {
<span class="fc" id="L345">        final double kE = 1.0; // brightness factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L346">        final double kCH = 1.0; // chroma and hue factor, 1.0 for CIE reference conditions</span>
<span class="fc" id="L347">        final double fac1 = 100.0 / Math.log(139.0 / 100.0); // L99 scaling factor = 303.67100547050995</span>
<span class="fc" id="L348">        final double ang = Math.toRadians(26.0);</span>

<span class="fc" id="L350">        final double l = (Math.exp(l99o * kE / fac1) - 1.0) / 0.0039;</span>

<span class="fc" id="L352">        final double h99ef = Math.atan2(b99o, a99o); // arctan in four quadrants</span>

<span class="fc" id="L354">        final double heofo = h99ef - ang; // backwards hue rotation</span>

<span class="fc" id="L356">        final double c99 = Math.sqrt(a99o * a99o + b99o * b99o); // DIN99 chroma</span>
<span class="fc" id="L357">        final double g = (Math.exp(0.0435 * kE * kCH * c99) - 1.0) / 0.075; // factor for chroma decompression and viewing conditions</span>
<span class="fc" id="L358">        final double e = g * Math.cos(heofo);</span>
<span class="fc" id="L359">        final double f = g * Math.sin(heofo);</span>

<span class="fc" id="L361">        final double a = e * Math.cos(ang) - f / 0.83 * Math.sin(ang); // rotation by 26 degrees</span>
<span class="fc" id="L362">        final double b = e * Math.sin(ang) + f / 0.83 * Math.cos(ang); // rotation by 26 degrees</span>

<span class="fc" id="L364">        return new ColorCieLab(l, a, b);</span>
    }

    public static int convertHslToRgb(final ColorHsl hsl) {
<span class="fc" id="L368">        return convertHslToRgb(hsl.h, hsl.s, hsl.l);</span>
    }

    public static int convertHslToRgb(final double h, final double s, final double l) {
        double r, g, b;

<span class="fc bfc" id="L374" title="All 2 branches covered.">        if (s == 0) {</span>
            // HSL values = 0 ÷ 1
<span class="fc" id="L376">            r = l * 255; // RGB results = 0 ÷ 255</span>
<span class="fc" id="L377">            g = l * 255;</span>
<span class="fc" id="L378">            b = l * 255;</span>
        } else {
            double var2;

<span class="pc bpc" id="L382" title="1 of 2 branches missed.">            if (l &lt; 0.5) {</span>
<span class="nc" id="L383">                var2 = l * (1 + s);</span>
            } else {
<span class="fc" id="L385">                var2 = l + s - s * l;</span>
            }

<span class="fc" id="L388">            final double var1 = 2 * l - var2;</span>

<span class="fc" id="L390">            r = 255 * convertHueToRgb(var1, var2, h + 1 / 3.0);</span>
<span class="fc" id="L391">            g = 255 * convertHueToRgb(var1, var2, h);</span>
<span class="fc" id="L392">            b = 255 * convertHueToRgb(var1, var2, h - 1 / 3.0);</span>
        }

<span class="fc" id="L395">        return convertRgbToRgb(r, g, b);</span>
    }

    public static int convertHsvToRgb(final ColorHsv HSV) {
<span class="fc" id="L399">        return convertHsvToRgb(HSV.h, HSV.s, HSV.v);</span>
    }

    public static int convertHsvToRgb(final double h, final double s, final double v) {
        double r, g, b;

<span class="fc bfc" id="L405" title="All 2 branches covered.">        if (s == 0) {</span>
            // HSV values = 0 ÷ 1
<span class="fc" id="L407">            r = v * 255;</span>
<span class="fc" id="L408">            g = v * 255;</span>
<span class="fc" id="L409">            b = v * 255;</span>
        } else {
<span class="fc" id="L411">            double varH = h * 6;</span>
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">            if (varH == 6) {</span>
<span class="nc" id="L413">                varH = 0; // H must be &lt; 1</span>
            }
<span class="fc" id="L415">            final double varI = Math.floor(varH); // Or ... varI = floor( varH )</span>
<span class="fc" id="L416">            final double var1 = v * (1 - s);</span>
<span class="fc" id="L417">            final double var2 = v * (1 - s * (varH - varI));</span>
<span class="fc" id="L418">            final double var3 = v * (1 - s * (1 - (varH - varI)));</span>

            double varR, varG, varB;

<span class="fc bfc" id="L422" title="All 2 branches covered.">            if (varI == 0) {</span>
<span class="fc" id="L423">                varR = v;</span>
<span class="fc" id="L424">                varG = var3;</span>
<span class="fc" id="L425">                varB = var1;</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">            } else if (varI == 1) {</span>
<span class="fc" id="L427">                varR = var2;</span>
<span class="fc" id="L428">                varG = v;</span>
<span class="fc" id="L429">                varB = var1;</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">            } else if (varI == 2) {</span>
<span class="fc" id="L431">                varR = var1;</span>
<span class="fc" id="L432">                varG = v;</span>
<span class="fc" id="L433">                varB = var3;</span>
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">            } else if (varI == 3) {</span>
<span class="nc" id="L435">                varR = var1;</span>
<span class="nc" id="L436">                varG = var2;</span>
<span class="nc" id="L437">                varB = v;</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">            } else if (varI == 4) {</span>
<span class="fc" id="L439">                varR = var3;</span>
<span class="fc" id="L440">                varG = var1;</span>
<span class="fc" id="L441">                varB = v;</span>
            } else {
<span class="fc" id="L443">                varR = v;</span>
<span class="fc" id="L444">                varG = var1;</span>
<span class="fc" id="L445">                varB = var2;</span>
            }

<span class="fc" id="L448">            r = varR * 255; // RGB results = 0 ÷ 255</span>
<span class="fc" id="L449">            g = varG * 255;</span>
<span class="fc" id="L450">            b = varB * 255;</span>
        }

<span class="fc" id="L453">        return convertRgbToRgb(r, g, b);</span>
    }

    private static double convertHueToRgb(final double v1, final double v2, double vH) {
<span class="fc bfc" id="L457" title="All 2 branches covered.">        if (vH &lt; 0) {</span>
<span class="fc" id="L458">            vH += 1;</span>
        }
<span class="fc bfc" id="L460" title="All 2 branches covered.">        if (vH &gt; 1) {</span>
<span class="fc" id="L461">            vH -= 1;</span>
        }
<span class="fc bfc" id="L463" title="All 2 branches covered.">        if (6 * vH &lt; 1) {</span>
<span class="fc" id="L464">            return v1 + (v2 - v1) * 6 * vH;</span>
        }
<span class="fc bfc" id="L466" title="All 2 branches covered.">        if (2 * vH &lt; 1) {</span>
<span class="fc" id="L467">            return v2;</span>
        }
<span class="fc bfc" id="L469" title="All 2 branches covered.">        if (3 * vH &lt; 2) {</span>
<span class="fc" id="L470">            return v1 + (v2 - v1) * (2 / 3.0 - vH) * 6;</span>
        }
<span class="fc" id="L472">        return v1;</span>
    }

    public static ColorXyz convertHunterLabToXyz(final ColorHunterLab cielab) {
<span class="fc" id="L476">        return convertHunterLabToXyz(cielab.l, cielab.a, cielab.b);</span>
    }

    public static ColorXyz convertHunterLabToXyz(final double l, final double a, final double b) {
<span class="fc" id="L480">        final double varY = l / 10;</span>
<span class="fc" id="L481">        final double varX = a / 17.5 * l / 10;</span>
<span class="fc" id="L482">        final double varZ = b / 7 * l / 10;</span>

<span class="fc" id="L484">        final double y = Math.pow(varY, 2);</span>
<span class="fc" id="L485">        final double x = (varX + y) / 1.02;</span>
<span class="fc" id="L486">        final double z = -(varZ - y) / 0.847;</span>

<span class="fc" id="L488">        return new ColorXyz(x, y, z);</span>
    }

    public static ColorCmy convertRgbToCmy(final int rgb) {
<span class="fc" id="L492">        final int r = 0xff &amp; rgb &gt;&gt; 16;</span>
<span class="fc" id="L493">        final int g = 0xff &amp; rgb &gt;&gt; 8;</span>
<span class="fc" id="L494">        final int b = 0xff &amp; rgb &gt;&gt; 0;</span>

        // RGB values = 0 ÷ 255
        // CMY values = 0 ÷ 1

<span class="fc" id="L499">        final double c = 1 - r / 255.0;</span>
<span class="fc" id="L500">        final double m = 1 - g / 255.0;</span>
<span class="fc" id="L501">        final double y = 1 - b / 255.0;</span>

<span class="fc" id="L503">        return new ColorCmy(c, m, y);</span>
    }

    public static ColorHsl convertRgbToHsl(final int rgb) {

<span class="fc" id="L508">        final int r = 0xff &amp; rgb &gt;&gt; 16;</span>
<span class="fc" id="L509">        final int g = 0xff &amp; rgb &gt;&gt; 8;</span>
<span class="fc" id="L510">        final int b = 0xff &amp; rgb &gt;&gt; 0;</span>

<span class="fc" id="L512">        final double varR = r / 255.0; // Where RGB values = 0 ÷ 255</span>
<span class="fc" id="L513">        final double varG = g / 255.0;</span>
<span class="fc" id="L514">        final double varB = b / 255.0;</span>

<span class="fc" id="L516">        final double varMin = Math.min(varR, Math.min(varG, varB)); // Min. value</span>
                                                                    // of RGB
        double varMax;
<span class="fc" id="L519">        boolean maxIsR = false;</span>
<span class="fc" id="L520">        boolean maxIsG = false;</span>
<span class="fc bfc" id="L521" title="All 4 branches covered.">        if (varR &gt;= varG &amp;&amp; varR &gt;= varB) {</span>
<span class="fc" id="L522">            varMax = varR;</span>
<span class="fc" id="L523">            maxIsR = true;</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">        } else if (varG &gt; varB) {</span>
<span class="fc" id="L525">            varMax = varG;</span>
<span class="fc" id="L526">            maxIsG = true;</span>
        } else {
<span class="fc" id="L528">            varMax = varB;</span>
        }
<span class="fc" id="L530">        final double delMax = varMax - varMin; // Delta RGB value</span>

<span class="fc" id="L532">        final double l = (varMax + varMin) / 2.0;</span>

        double h, s;
        // Debug.debug(&quot;del_Max&quot;, del_Max);
<span class="fc bfc" id="L536" title="All 2 branches covered.">        if (delMax == 0) {</span>
            // This is a gray, no chroma...

<span class="fc" id="L539">            h = 0; // HSL results = 0 ÷ 1</span>
<span class="fc" id="L540">            s = 0;</span>
        } else {
            // Chromatic data...

            // Debug.debug(&quot;L&quot;, L);

<span class="pc bpc" id="L546" title="1 of 2 branches missed.">            if (l &lt; 0.5) {</span>
<span class="nc" id="L547">                s = delMax / (varMax + varMin);</span>
            } else {
<span class="fc" id="L549">                s = delMax / (2 - varMax - varMin);</span>
            }

            // Debug.debug(&quot;S&quot;, S);

<span class="fc" id="L554">            final double delR = ((varMax - varR) / 6 + delMax / 2) / delMax;</span>
<span class="fc" id="L555">            final double delG = ((varMax - varG) / 6 + delMax / 2) / delMax;</span>
<span class="fc" id="L556">            final double delB = ((varMax - varB) / 6 + delMax / 2) / delMax;</span>

<span class="fc bfc" id="L558" title="All 2 branches covered.">            if (maxIsR) {</span>
<span class="fc" id="L559">                h = delB - delG;</span>
<span class="fc bfc" id="L560" title="All 2 branches covered.">            } else if (maxIsG) {</span>
<span class="fc" id="L561">                h = 1 / 3.0 + delR - delB;</span>
            } else {
<span class="fc" id="L563">                h = 2 / 3.0 + delG - delR;</span>
            }

            // Debug.debug(&quot;H1&quot;, H);

<span class="fc bfc" id="L568" title="All 2 branches covered.">            if (h &lt; 0) {</span>
<span class="fc" id="L569">                h += 1;</span>
            }
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">            if (h &gt; 1) {</span>
<span class="nc" id="L572">                h -= 1;</span>
            }

            // Debug.debug(&quot;H2&quot;, H);
        }

<span class="fc" id="L578">        return new ColorHsl(h, s, l);</span>
    }

    public static ColorHsv convertRgbToHsv(final int rgb) {
<span class="fc" id="L582">        final int r = 0xff &amp; rgb &gt;&gt; 16;</span>
<span class="fc" id="L583">        final int g = 0xff &amp; rgb &gt;&gt; 8;</span>
<span class="fc" id="L584">        final int b = 0xff &amp; rgb &gt;&gt; 0;</span>

<span class="fc" id="L586">        final double varR = r / 255.0; // RGB values = 0 ÷ 255</span>
<span class="fc" id="L587">        final double varG = g / 255.0;</span>
<span class="fc" id="L588">        final double varB = b / 255.0;</span>

<span class="fc" id="L590">        final double varMin = Math.min(varR, Math.min(varG, varB)); // Min. value</span>
                                                                    // of RGB
<span class="fc" id="L592">        boolean maxIsR = false;</span>
<span class="fc" id="L593">        boolean maxIsG = false;</span>
        double varMax;
<span class="fc bfc" id="L595" title="All 4 branches covered.">        if (varR &gt;= varG &amp;&amp; varR &gt;= varB) {</span>
<span class="fc" id="L596">            varMax = varR;</span>
<span class="fc" id="L597">            maxIsR = true;</span>
<span class="fc bfc" id="L598" title="All 2 branches covered.">        } else if (varG &gt; varB) {</span>
<span class="fc" id="L599">            varMax = varG;</span>
<span class="fc" id="L600">            maxIsG = true;</span>
        } else {
<span class="fc" id="L602">            varMax = varB;</span>
        }
<span class="fc" id="L604">        final double delMax = varMax - varMin; // Delta RGB value</span>

<span class="fc" id="L606">        final double v = varMax;</span>

        double h, s;
<span class="fc bfc" id="L609" title="All 2 branches covered.">        if (delMax == 0) {</span>
            // This is a gray, no chroma...
<span class="fc" id="L611">            h = 0; // HSV results = 0 ÷ 1</span>
<span class="fc" id="L612">            s = 0;</span>
        } else {
            // Chromatic data...
<span class="fc" id="L615">            s = delMax / varMax;</span>

<span class="fc" id="L617">            final double delR = ((varMax - varR) / 6 + delMax / 2) / delMax;</span>
<span class="fc" id="L618">            final double delG = ((varMax - varG) / 6 + delMax / 2) / delMax;</span>
<span class="fc" id="L619">            final double delB = ((varMax - varB) / 6 + delMax / 2) / delMax;</span>

<span class="fc bfc" id="L621" title="All 2 branches covered.">            if (maxIsR) {</span>
<span class="fc" id="L622">                h = delB - delG;</span>
<span class="fc bfc" id="L623" title="All 2 branches covered.">            } else if (maxIsG) {</span>
<span class="fc" id="L624">                h = 1 / 3.0 + delR - delB;</span>
            } else {
<span class="fc" id="L626">                h = 2 / 3.0 + delG - delR;</span>
            }

<span class="fc bfc" id="L629" title="All 2 branches covered.">            if (h &lt; 0) {</span>
<span class="fc" id="L630">                h += 1;</span>
            }
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">            if (h &gt; 1) {</span>
<span class="nc" id="L633">                h -= 1;</span>
            }
        }

<span class="fc" id="L637">        return new ColorHsv(h, s, v);</span>
    }

    private static int convertRgbToRgb(final double r, final double g, final double b) {
<span class="fc" id="L641">        int red = (int) Math.round(r);</span>
<span class="fc" id="L642">        int green = (int) Math.round(g);</span>
<span class="fc" id="L643">        int blue = (int) Math.round(b);</span>

<span class="fc" id="L645">        red = Math.min(255, Math.max(0, red));</span>
<span class="fc" id="L646">        green = Math.min(255, Math.max(0, green));</span>
<span class="fc" id="L647">        blue = Math.min(255, Math.max(0, blue));</span>

<span class="fc" id="L649">        final int alpha = 0xff;</span>

<span class="fc" id="L651">        return alpha &lt;&lt; 24 | red &lt;&lt; 16 | green &lt;&lt; 8 | blue &lt;&lt; 0;</span>
    }

    private static int convertRgbToRgb(int red, int green, int blue) {
<span class="nc" id="L655">        red = Math.min(255, Math.max(0, red));</span>
<span class="nc" id="L656">        green = Math.min(255, Math.max(0, green));</span>
<span class="nc" id="L657">        blue = Math.min(255, Math.max(0, blue));</span>

<span class="nc" id="L659">        final int alpha = 0xff;</span>

<span class="nc" id="L661">        return alpha &lt;&lt; 24 | red &lt;&lt; 16 | green &lt;&lt; 8 | blue &lt;&lt; 0;</span>
    }

    // See also c# implementation:
    // https://github.com/muak/ColorMinePortable/blob/master/ColorMinePortable/ColorSpaces/Conversions/XyzConverter.cs
    public static ColorXyz convertRgbToXyz(final int rgb) {
<span class="fc" id="L667">        final int r = 0xff &amp; rgb &gt;&gt; 16;</span>
<span class="fc" id="L668">        final int g = 0xff &amp; rgb &gt;&gt; 8;</span>
<span class="fc" id="L669">        final int b = 0xff &amp; rgb &gt;&gt; 0;</span>

<span class="fc" id="L671">        double varR = r / 255.0; // Where R = 0 ÷ 255</span>
<span class="fc" id="L672">        double varG = g / 255.0; // Where G = 0 ÷ 255</span>
<span class="fc" id="L673">        double varB = b / 255.0; // Where B = 0 ÷ 255</span>

        // Pivot RGB:
<span class="fc" id="L676">        varR = unPivotRgb(varR);</span>
<span class="fc" id="L677">        varG = unPivotRgb(varG);</span>
<span class="fc" id="L678">        varB = unPivotRgb(varB);</span>

<span class="fc" id="L680">        varR *= 100;</span>
<span class="fc" id="L681">        varG *= 100;</span>
<span class="fc" id="L682">        varB *= 100;</span>

        // Observer. = 2°, Illuminant = D65
        // see: https://github.com/StanfordHCI/c3/blob/master/java/src/edu/stanford/vis/color/LAB.java
<span class="fc" id="L686">        final double X = varR * 0.4124564 + varG * 0.3575761 + varB * 0.1804375;</span>
<span class="fc" id="L687">        final double Y = varR * 0.2126729 + varG * 0.7151522 + varB * 0.0721750;</span>
<span class="fc" id="L688">        final double Z = varR * 0.0193339 + varG * 0.1191920 + varB * 0.9503041;</span>

        // Attention: A lot of sources do list these values with less precision. But it makes a visual difference:
        // final double X = var_R * 0.4124 + var_G * 0.3576 + var_B * 0.1805;
        // final double Y = var_R * 0.2126 + var_G * 0.7152 + var_B * 0.0722;
        // final double Z = var_R * 0.0193 + var_G * 0.1192 + var_B * 0.9505;

<span class="fc" id="L695">        return new ColorXyz(X, Y, Z);</span>
    }

    public static ColorCieLuv convertXuzToCieLuv(final double x, final double y, final double z) {
        // problems here with div by zero

<span class="fc" id="L701">        final double varU = 4 * x / (x + 15 * y + 3 * z);</span>
<span class="fc" id="L702">        final double varV = 9 * y / (x + 15 * y + 3 * z);</span>

        // Debug.debug(&quot;var_U&quot;, var_U);
        // Debug.debug(&quot;var_V&quot;, var_V);

<span class="fc" id="L707">        double varY = y / 100.0;</span>
        // Debug.debug(&quot;var_Y&quot;, var_Y);

<span class="fc" id="L710">        varY = pivotXyz(varY);</span>

        // Debug.debug(&quot;var_Y&quot;, var_Y);

<span class="fc" id="L714">        final double refU = 4 * REF_X / (REF_X + 15 * REF_Y + 3 * REF_Z);</span>
<span class="fc" id="L715">        final double refV = 9 * REF_Y / (REF_X + 15 * REF_Y + 3 * REF_Z);</span>

        // Debug.debug(&quot;ref_U&quot;, ref_U);
        // Debug.debug(&quot;ref_V&quot;, ref_V);

<span class="fc" id="L720">        final double l = 116 * varY - 16;</span>
<span class="fc" id="L721">        final double u = 13 * l * (varU - refU);</span>
<span class="fc" id="L722">        final double v = 13 * l * (varV - refV);</span>

<span class="fc" id="L724">        return new ColorCieLuv(l, u, v);</span>
    }

    public static ColorCieLab convertXyzToCieLab(final ColorXyz xyz) {
<span class="fc" id="L728">        return convertXyzToCieLab(xyz.x, xyz.y, xyz.z);</span>
    }

    public static ColorCieLab convertXyzToCieLab(final double x, final double y, final double z) {

<span class="fc" id="L733">        double varX = x / REF_X; // REF_X = 95.047 Observer= 2°, Illuminant= D65</span>
<span class="fc" id="L734">        double varY = y / REF_Y; // REF_Y = 100.000</span>
<span class="fc" id="L735">        double varZ = z / REF_Z; // REF_Z = 108.883</span>

        // Pivot XÝZ:
<span class="fc" id="L738">        varX = pivotXyz(varX);</span>
<span class="fc" id="L739">        varY = pivotXyz(varY);</span>
<span class="fc" id="L740">        varZ = pivotXyz(varZ);</span>

        // Math.max added from https://github.com/muak/ColorMinePortable/blob/master/ColorMinePortable/ColorSpaces/Conversions/LabConverter.cs
<span class="fc" id="L743">        final double l = Math.max(0, 116 * varY - 16);</span>
<span class="fc" id="L744">        final double a = 500 * (varX - varY);</span>
<span class="fc" id="L745">        final double b = 200 * (varY - varZ);</span>
<span class="fc" id="L746">        return new ColorCieLab(l, a, b);</span>
    }

    public static ColorCieLuv convertXyzToCieLuv(final ColorXyz xyz) {
<span class="fc" id="L750">        return convertXuzToCieLuv(xyz.x, xyz.y, xyz.z);</span>
    }

    public static ColorHunterLab convertXyzToHunterLab(final ColorXyz xyz) {
<span class="fc" id="L754">        return convertXyzToHunterLab(xyz.x, xyz.y, xyz.z);</span>
    }

    public static ColorHunterLab convertXyzToHunterLab(final double x, final double y, final double z) {
<span class="fc" id="L758">        final double l = 10 * Math.sqrt(y);</span>
<span class="fc bfc" id="L759" title="All 2 branches covered.">        final double a = y == 0.0 ? 0.0 : 17.5 * ((1.02 * x - y) / Math.sqrt(y));</span>
<span class="fc bfc" id="L760" title="All 2 branches covered.">        final double b = y == 0.0 ? 0.0 : 7 * ((y - 0.847 * z) / Math.sqrt(y));</span>

<span class="fc" id="L762">        return new ColorHunterLab(l, a, b);</span>
    }

    public static int convertXyzToRgb(final ColorXyz xyz) {
<span class="fc" id="L766">        return convertXyzToRgb(xyz.x, xyz.y, xyz.z);</span>
    }

    public static int convertXyzToRgb(final double x, final double y, final double z) {
        // Observer = 2°, Illuminant = D65
<span class="fc" id="L771">        final double varX = x / 100.0; // Where X = 0 ÷ 95.047</span>
<span class="fc" id="L772">        final double varY = y / 100.0; // Where Y = 0 ÷ 100.000</span>
<span class="fc" id="L773">        final double varZ = z / 100.0; // Where Z = 0 ÷ 108.883</span>

        // see: https://github.com/StanfordHCI/c3/blob/master/java/src/edu/stanford/vis/color/LAB.java
<span class="fc" id="L776">        double varR = varX * 3.2404542 + varY * -1.5371385 + varZ * -0.4985314;</span>
<span class="fc" id="L777">        double varG = varX * -0.9692660 + varY * 1.8760108 + varZ * 0.0415560;</span>
<span class="fc" id="L778">        double varB = varX * 0.0556434 + varY * -0.2040259 + varZ * 1.0572252;</span>

        // Attention: A lot of sources do list these values with less precision. But it makes a visual difference:
        // double var_R = var_X * 3.2406 + var_Y * -1.5372 + var_Z * -0.4986;
        // double var_G = var_X * -0.9689 + var_Y * 1.8758 + var_Z * 0.0415;
        // double var_B = var_X * 0.0557 + var_Y * -0.2040 + var_Z * 1.0570;

<span class="fc" id="L785">        varR = pivotRgb(varR);</span>
<span class="fc" id="L786">        varG = pivotRgb(varG);</span>
<span class="fc" id="L787">        varB = pivotRgb(varB);</span>

<span class="fc" id="L789">        final double r = varR * 255;</span>
<span class="fc" id="L790">        final double g = varG * 255;</span>
<span class="fc" id="L791">        final double b = varB * 255;</span>
<span class="fc" id="L792">        return convertRgbToRgb(r, g, b);</span>
    }

    public static double degree2radian(final double degree) {
<span class="fc" id="L796">        return degree * Math.PI / 180.0;</span>
    }

    private static double pivotRgb(double n) {
<span class="fc bfc" id="L800" title="All 2 branches covered.">        if (n &gt; 0.0031308) {</span>
<span class="fc" id="L801">            n = 1.055 * Math.pow(n, 1 / 2.4) - 0.055;</span>
        } else {
<span class="fc" id="L803">            n = 12.92 * n;</span>
        }
<span class="fc" id="L805">        return n;</span>
    }

    private static double pivotXyz(double n) {
<span class="fc bfc" id="L809" title="All 2 branches covered.">        if (n &gt; XYZ_t0) {</span>
<span class="fc" id="L810">            n = Math.pow(n, 1 / 3.0);</span>
        } else {
<span class="fc" id="L812">            n = XYZ_m * n + 16 / 116.0;</span>
        }
<span class="fc" id="L814">        return n;</span>
    }

    public static double radian2degree(final double radian) {
<span class="nc" id="L818">        return radian * 180.0 / Math.PI;</span>
    }

    private static double square(final double f) {
<span class="fc" id="L822">        return f * f;</span>
    }

    private static double unPivotRgb(double n) {
<span class="fc bfc" id="L826" title="All 2 branches covered.">        if (n &gt; 0.04045) {</span>
<span class="fc" id="L827">            n = Math.pow((n + 0.055) / 1.055, 2.4);</span>
        } else {
<span class="fc" id="L829">            n /= 12.92;</span>
        }
<span class="fc" id="L831">        return n;</span>
    }

    private static double unPivotXyz(double n) {
<span class="fc" id="L835">        final double nCube = Math.pow(n, 3);</span>
<span class="fc bfc" id="L836" title="All 2 branches covered.">        if (nCube &gt; XYZ_t0) {</span>
<span class="fc" id="L837">            n = nCube;</span>
        } else {
<span class="fc" id="L839">            n = (n - 16 / 116.0) / XYZ_m;</span>
        }
<span class="fc" id="L841">        return n;</span>
    }

    private ColorConversions() {
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>