<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BmpImageParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons Imaging</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.imaging.formats.bmp</a> &gt; <span class="el_source">BmpImageParser.java</span></div><h1>BmpImageParser.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.imaging.formats.bmp;

import static org.apache.commons.imaging.common.BinaryFunctions.read2Bytes;
import static org.apache.commons.imaging.common.BinaryFunctions.read4Bytes;
import static org.apache.commons.imaging.common.BinaryFunctions.readByte;
import static org.apache.commons.imaging.common.BinaryFunctions.readBytes;

import java.awt.Dimension;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.nio.ByteOrder;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.apache.commons.imaging.AbstractImageParser;
import org.apache.commons.imaging.FormatCompliance;
import org.apache.commons.imaging.ImageFormat;
import org.apache.commons.imaging.ImageFormats;
import org.apache.commons.imaging.ImageInfo;
import org.apache.commons.imaging.ImagingException;
import org.apache.commons.imaging.PixelDensity;
import org.apache.commons.imaging.bytesource.ByteSource;
import org.apache.commons.imaging.common.BinaryOutputStream;
import org.apache.commons.imaging.common.ImageBuilder;
import org.apache.commons.imaging.common.ImageMetadata;
import org.apache.commons.imaging.palette.PaletteFactory;
import org.apache.commons.imaging.palette.SimplePalette;

public class BmpImageParser extends AbstractImageParser&lt;BmpImagingParameters&gt; {

<span class="fc" id="L53">    private static final Logger LOGGER = Logger.getLogger(BmpImageParser.class.getName());</span>

<span class="fc" id="L55">    private static final String DEFAULT_EXTENSION = ImageFormats.BMP.getDefaultExtension();</span>
<span class="fc" id="L56">    private static final String[] ACCEPTED_EXTENSIONS = ImageFormats.BMP.getExtensions();</span>
<span class="fc" id="L57">    private static final byte[] BMP_HEADER_SIGNATURE = { 0x42, 0x4d, };</span>
    private static final int BI_RGB = 0;
    private static final int BI_RLE4 = 2;
    private static final int BI_RLE8 = 1;
    private static final int BI_BITFIELDS = 3;
    private static final int BITMAP_FILE_HEADER_SIZE = 14;
    private static final int BITMAP_INFO_HEADER_SIZE = 40;

    public BmpImageParser() {
<span class="fc" id="L66">        super(ByteOrder.LITTLE_ENDIAN);</span>
<span class="fc" id="L67">    }</span>

    @Override
    public boolean dumpImageFile(final PrintWriter pw, final ByteSource byteSource) throws ImagingException, IOException {
<span class="fc" id="L71">        pw.println(&quot;bmp.dumpImageFile&quot;);</span>

<span class="fc" id="L73">        final ImageInfo imageData = getImageInfo(byteSource, null);</span>

<span class="fc" id="L75">        imageData.toString(pw, &quot;&quot;);</span>

<span class="fc" id="L77">        pw.println(&quot;&quot;);</span>

<span class="fc" id="L79">        return true;</span>
    }

    @Override
    protected String[] getAcceptedExtensions() {
<span class="fc" id="L84">        return ACCEPTED_EXTENSIONS;</span>
    }

    @Override
    protected ImageFormat[] getAcceptedTypes() {
<span class="fc" id="L89">        return new ImageFormat[] { ImageFormats.BMP };</span>
    }

    private String getBmpTypeDescription(final int identifier1, final int identifier2) {
<span class="pc bpc" id="L93" title="2 of 4 branches missed.">        if (identifier1 == 'B' &amp;&amp; identifier2 == 'M') {</span>
<span class="fc" id="L94">            return &quot;Windows 3.1x, 95, NT,&quot;;</span>
        }
<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (identifier1 == 'B' &amp;&amp; identifier2 == 'A') {</span>
<span class="nc" id="L97">            return &quot;OS/2 Bitmap Array&quot;;</span>
        }
<span class="nc bnc" id="L99" title="All 4 branches missed.">        if (identifier1 == 'C' &amp;&amp; identifier2 == 'I') {</span>
<span class="nc" id="L100">            return &quot;OS/2 Color Icon&quot;;</span>
        }
<span class="nc bnc" id="L102" title="All 4 branches missed.">        if (identifier1 == 'C' &amp;&amp; identifier2 == 'P') {</span>
<span class="nc" id="L103">            return &quot;OS/2 Color Pointer&quot;;</span>
        }
<span class="nc bnc" id="L105" title="All 4 branches missed.">        if (identifier1 == 'I' &amp;&amp; identifier2 == 'C') {</span>
<span class="nc" id="L106">            return &quot;OS/2 Icon&quot;;</span>
        }
<span class="nc bnc" id="L108" title="All 4 branches missed.">        if (identifier1 == 'P' &amp;&amp; identifier2 == 'T') {</span>
<span class="nc" id="L109">            return &quot;OS/2 Pointer&quot;;</span>
        }

<span class="nc" id="L112">        return &quot;Unknown&quot;;</span>
    }

    @Override
    public BufferedImage getBufferedImage(final ByteSource byteSource, final BmpImagingParameters params) throws ImagingException, IOException {
<span class="fc" id="L117">        try (InputStream is = byteSource.getInputStream()) {</span>
<span class="fc" id="L118">            return getBufferedImage(is, params);</span>
        }
    }

    public BufferedImage getBufferedImage(final InputStream inputStream, final BmpImagingParameters params) throws ImagingException, IOException {
<span class="fc" id="L123">        final BmpImageContents ic = readImageContents(inputStream, FormatCompliance.getDefault());</span>

<span class="fc" id="L125">        final BmpHeaderInfo bhi = ic.bhi;</span>
        // byte[] colorTable = ic.colorTable;
        // byte[] imageData = ic.imageData;

<span class="fc" id="L129">        final int width = bhi.width;</span>
<span class="fc" id="L130">        final int height = bhi.height;</span>

<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L133">            LOGGER.fine(&quot;width: &quot; + width);</span>
<span class="nc" id="L134">            LOGGER.fine(&quot;height: &quot; + height);</span>
<span class="nc" id="L135">            LOGGER.fine(&quot;width*height: &quot; + width * height);</span>
<span class="nc" id="L136">            LOGGER.fine(&quot;width*height*4: &quot; + width * height * 4);</span>
        }

<span class="fc" id="L139">        final AbstractPixelParser abstractPixelParser = ic.abstractPixelParser;</span>
<span class="fc" id="L140">        final ImageBuilder imageBuilder = new ImageBuilder(width, height, true);</span>
<span class="fc" id="L141">        abstractPixelParser.processImage(imageBuilder);</span>

<span class="fc" id="L143">        return imageBuilder.getBufferedImage();</span>

    }

    @Override
    public String getDefaultExtension() {
<span class="nc" id="L149">        return DEFAULT_EXTENSION;</span>
    }

    @Override
    public BmpImagingParameters getDefaultParameters() {
<span class="fc" id="L154">        return new BmpImagingParameters();</span>
    }

    @Override
    public FormatCompliance getFormatCompliance(final ByteSource byteSource) throws ImagingException, IOException {
<span class="nc" id="L159">        final FormatCompliance result = new FormatCompliance(byteSource.toString());</span>

<span class="nc" id="L161">        try (InputStream is = byteSource.getInputStream()) {</span>
<span class="nc" id="L162">            readImageContents(is, result);</span>
        }

<span class="nc" id="L165">        return result;</span>
    }

    @Override
    public byte[] getIccProfileBytes(final ByteSource byteSource, final BmpImagingParameters params) {
<span class="fc" id="L170">        return null;</span>
    }

    @Override
    public ImageInfo getImageInfo(final ByteSource byteSource, final BmpImagingParameters params) throws ImagingException, IOException {
<span class="fc" id="L175">        BmpImageContents ic = null;</span>
<span class="fc" id="L176">        try (InputStream is = byteSource.getInputStream()) {</span>
<span class="fc" id="L177">            ic = readImageContents(is, FormatCompliance.getDefault());</span>
        }

<span class="fc" id="L180">        final BmpHeaderInfo bhi = ic.bhi;</span>
<span class="fc" id="L181">        final byte[] colorTable = ic.colorTable;</span>

<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (bhi == null) {</span>
<span class="nc" id="L184">            throw new ImagingException(&quot;BMP: couldn't read header&quot;);</span>
        }

<span class="fc" id="L187">        final int height = bhi.height;</span>
<span class="fc" id="L188">        final int width = bhi.width;</span>

<span class="fc" id="L190">        final List&lt;String&gt; comments = new ArrayList&lt;&gt;();</span>
        // TODO: comments...

<span class="fc" id="L193">        final int bitsPerPixel = bhi.bitsPerPixel;</span>
<span class="fc" id="L194">        final ImageFormat format = ImageFormats.BMP;</span>
<span class="fc" id="L195">        final String name = &quot;BMP Windows Bitmap&quot;;</span>
<span class="fc" id="L196">        final String mimeType = &quot;image/x-ms-bmp&quot;;</span>
        // we ought to count images, but don't yet.
<span class="fc" id="L198">        final int numberOfImages = -1;</span>
        // not accurate ... only reflects first
<span class="fc" id="L200">        final boolean progressive = false;</span>
        // boolean progressive = (fPNGChunkIHDR.InterlaceMethod != 0);
        //
        // pixels per meter
<span class="fc" id="L204">        final int physicalWidthDpi = (int) Math.round(bhi.hResolution * .0254);</span>
<span class="fc" id="L205">        final float physicalWidthInch = (float) ((double) width / (double) physicalWidthDpi);</span>
        // int physicalHeightDpi = 72;
<span class="fc" id="L207">        final int physicalHeightDpi = (int) Math.round(bhi.vResolution * .0254);</span>
<span class="fc" id="L208">        final float physicalHeightInch = (float) ((double) height / (double) physicalHeightDpi);</span>

<span class="fc" id="L210">        final String formatDetails = &quot;Bmp (&quot; + (char) bhi.identifier1 + (char) bhi.identifier2 + &quot;: &quot; + getBmpTypeDescription(bhi.identifier1, bhi.identifier2)</span>
                + &quot;)&quot;;

<span class="fc" id="L213">        final boolean transparent = false;</span>

<span class="fc bfc" id="L215" title="All 2 branches covered.">        final boolean usesPalette = colorTable != null;</span>
<span class="fc" id="L216">        final ImageInfo.ColorType colorType = ImageInfo.ColorType.RGB;</span>
<span class="fc" id="L217">        final ImageInfo.CompressionAlgorithm compressionAlgorithm = ImageInfo.CompressionAlgorithm.RLE;</span>

<span class="fc" id="L219">        return new ImageInfo(formatDetails, bitsPerPixel, comments, format, name, height, mimeType, numberOfImages, physicalHeightDpi, physicalHeightInch,</span>
                physicalWidthDpi, physicalWidthInch, width, progressive, transparent, usesPalette, colorType, compressionAlgorithm);
    }

    @Override
    public Dimension getImageSize(final ByteSource byteSource, final BmpImagingParameters params) throws ImagingException, IOException {
<span class="fc" id="L225">        final BmpHeaderInfo bhi = readBmpHeaderInfo(byteSource);</span>

<span class="fc" id="L227">        return new Dimension(bhi.width, bhi.height);</span>

    }

    @Override
    public ImageMetadata getMetadata(final ByteSource byteSource, final BmpImagingParameters params) {
        // TODO this should throw UnsupportedOperationException, but RoundtripTest has to be refactored completely before this can be changed
<span class="fc" id="L234">        return null;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L239">        return &quot;Bmp-Custom&quot;;</span>
    }

    private byte[] getRleBytes(final InputStream is, final int rleSamplesPerByte) throws IOException {
<span class="fc" id="L243">        final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>

        // this.setDebug(true);

<span class="fc" id="L247">        boolean done = false;</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        while (!done) {</span>
<span class="fc" id="L249">            final int a = 0xff &amp; readByte(&quot;RLE a&quot;, is, &quot;BMP: Bad RLE&quot;);</span>
<span class="fc" id="L250">            baos.write(a);</span>
<span class="fc" id="L251">            final int b = 0xff &amp; readByte(&quot;RLE b&quot;, is, &quot;BMP: Bad RLE&quot;);</span>
<span class="fc" id="L252">            baos.write(b);</span>

<span class="fc bfc" id="L254" title="All 2 branches covered.">            if (a == 0) {</span>
<span class="pc bpc" id="L255" title="1 of 4 branches missed.">                switch (b) {</span>
                case 0: // EOL
<span class="fc" id="L257">                    break;</span>
                case 1: // EOF
                    // System.out.println(&quot;xXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
                    // );
<span class="fc" id="L261">                    done = true;</span>
<span class="fc" id="L262">                    break;</span>
                case 2: {
                    // System.out.println(&quot;xXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
                    // );
<span class="fc" id="L266">                    final int c = 0xff &amp; readByte(&quot;RLE c&quot;, is, &quot;BMP: Bad RLE&quot;);</span>
<span class="fc" id="L267">                    baos.write(c);</span>
<span class="fc" id="L268">                    final int d = 0xff &amp; readByte(&quot;RLE d&quot;, is, &quot;BMP: Bad RLE&quot;);</span>
<span class="fc" id="L269">                    baos.write(d);</span>

                }
<span class="fc" id="L272">                    break;</span>
                default: {
<span class="nc" id="L274">                    int size = b / rleSamplesPerByte;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                    if (b % rleSamplesPerByte &gt; 0) {</span>
<span class="nc" id="L276">                        size++;</span>
                    }
<span class="nc bnc" id="L278" title="All 2 branches missed.">                    if (size % 2 != 0) {</span>
<span class="nc" id="L279">                        size++;</span>
                    }

                    // System.out.println(&quot;b: &quot; + b);
                    // System.out.println(&quot;size: &quot; + size);
                    // System.out.println(&quot;RLESamplesPerByte: &quot; +
                    // RLESamplesPerByte);
                    // System.out.println(&quot;xXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
                    // );
<span class="nc" id="L288">                    final byte[] bytes = readBytes(&quot;bytes&quot;, is, size, &quot;RLE: Absolute Mode&quot;);</span>
<span class="nc" id="L289">                    baos.write(bytes);</span>
                }
                    break;
                }
            }
<span class="fc" id="L294">        }</span>

<span class="fc" id="L296">        return baos.toByteArray();</span>
    }

    private BmpHeaderInfo readBmpHeaderInfo(final ByteSource byteSource) throws ImagingException, IOException {
<span class="fc" id="L300">        try (InputStream is = byteSource.getInputStream()) {</span>
            // readSignature(is);
<span class="fc" id="L302">            return readBmpHeaderInfo(is, null);</span>
        }
    }

    private BmpHeaderInfo readBmpHeaderInfo(final InputStream is, final FormatCompliance formatCompliance) throws ImagingException, IOException {
<span class="fc" id="L307">        final byte identifier1 = readByte(&quot;Identifier1&quot;, is, &quot;Not a Valid BMP File&quot;);</span>
<span class="fc" id="L308">        final byte identifier2 = readByte(&quot;Identifier2&quot;, is, &quot;Not a Valid BMP File&quot;);</span>

<span class="fc bfc" id="L310" title="All 2 branches covered.">        if (formatCompliance != null) {</span>
<span class="fc" id="L311">            formatCompliance.compareBytes(&quot;Signature&quot;, BMP_HEADER_SIGNATURE, new byte[] { identifier1, identifier2 });</span>
        }

<span class="fc" id="L314">        final int fileSize = read4Bytes(&quot;File Size&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L315">        final int reserved = read4Bytes(&quot;Reserved&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L316">        final int bitmapDataOffset = read4Bytes(&quot;Bitmap Data Offset&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>

<span class="fc" id="L318">        final int bitmapHeaderSize = read4Bytes(&quot;Bitmap Header Size&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L319">        int width = 0;</span>
<span class="fc" id="L320">        int height = 0;</span>
<span class="fc" id="L321">        int planes = 0;</span>
<span class="fc" id="L322">        int bitsPerPixel = 0;</span>
<span class="fc" id="L323">        int compression = 0;</span>
<span class="fc" id="L324">        int bitmapDataSize = 0;</span>
<span class="fc" id="L325">        int hResolution = 0;</span>
<span class="fc" id="L326">        int vResolution = 0;</span>
<span class="fc" id="L327">        int colorsUsed = 0;</span>
<span class="fc" id="L328">        int colorsImportant = 0;</span>
<span class="fc" id="L329">        int redMask = 0;</span>
<span class="fc" id="L330">        int greenMask = 0;</span>
<span class="fc" id="L331">        int blueMask = 0;</span>
<span class="fc" id="L332">        int alphaMask = 0;</span>
<span class="fc" id="L333">        int colorSpaceType = 0;</span>
<span class="fc" id="L334">        final BmpHeaderInfo.ColorSpace colorSpace = new BmpHeaderInfo.ColorSpace();</span>
<span class="fc" id="L335">        colorSpace.red = new BmpHeaderInfo.ColorSpaceCoordinate();</span>
<span class="fc" id="L336">        colorSpace.green = new BmpHeaderInfo.ColorSpaceCoordinate();</span>
<span class="fc" id="L337">        colorSpace.blue = new BmpHeaderInfo.ColorSpaceCoordinate();</span>
<span class="fc" id="L338">        int gammaRed = 0;</span>
<span class="fc" id="L339">        int gammaGreen = 0;</span>
<span class="fc" id="L340">        int gammaBlue = 0;</span>
<span class="fc" id="L341">        int intent = 0;</span>
<span class="fc" id="L342">        int profileData = 0;</span>
<span class="fc" id="L343">        int profileSize = 0;</span>
<span class="fc" id="L344">        int reservedV5 = 0;</span>

<span class="pc bpc" id="L346" title="1 of 2 branches missed.">        if (bitmapHeaderSize &lt; 40) {</span>
<span class="nc" id="L347">            throw new ImagingException(&quot;Invalid/unsupported BMP file&quot;);</span>
        }
        // BITMAPINFOHEADER
<span class="fc" id="L350">        width = read4Bytes(&quot;Width&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L351">        height = read4Bytes(&quot;Height&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L352">        planes = read2Bytes(&quot;Planes&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L353">        bitsPerPixel = read2Bytes(&quot;Bits Per Pixel&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L354">        compression = read4Bytes(&quot;Compression&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L355">        bitmapDataSize = read4Bytes(&quot;Bitmap Data Size&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L356">        hResolution = read4Bytes(&quot;HResolution&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L357">        vResolution = read4Bytes(&quot;VResolution&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L358">        colorsUsed = read4Bytes(&quot;ColorsUsed&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L359">        colorsImportant = read4Bytes(&quot;ColorsImportant&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc bfc" id="L360" title="All 4 branches covered.">        if (bitmapHeaderSize &gt;= 52 || compression == BI_BITFIELDS) {</span>
            // 52 = BITMAPV2INFOHEADER, now undocumented
            // see https://en.wikipedia.org/wiki/BMP_file_format
<span class="fc" id="L363">            redMask = read4Bytes(&quot;RedMask&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L364">            greenMask = read4Bytes(&quot;GreenMask&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L365">            blueMask = read4Bytes(&quot;BlueMask&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
        }
<span class="fc bfc" id="L367" title="All 2 branches covered.">        if (bitmapHeaderSize &gt;= 56) {</span>
            // 56 = the now undocumented BITMAPV3HEADER sometimes used by
            // Photoshop
            // see [BROKEN URL] http://forums.adobe.com/thread/751592?tstart=1
<span class="fc" id="L371">            alphaMask = read4Bytes(&quot;AlphaMask&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
        }
<span class="fc bfc" id="L373" title="All 2 branches covered.">        if (bitmapHeaderSize &gt;= 108) {</span>
            // BITMAPV4HEADER
<span class="fc" id="L375">            colorSpaceType = read4Bytes(&quot;ColorSpaceType&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L376">            colorSpace.red.x = read4Bytes(&quot;ColorSpaceRedX&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L377">            colorSpace.red.y = read4Bytes(&quot;ColorSpaceRedY&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L378">            colorSpace.red.z = read4Bytes(&quot;ColorSpaceRedZ&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L379">            colorSpace.green.x = read4Bytes(&quot;ColorSpaceGreenX&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L380">            colorSpace.green.y = read4Bytes(&quot;ColorSpaceGreenY&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L381">            colorSpace.green.z = read4Bytes(&quot;ColorSpaceGreenZ&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L382">            colorSpace.blue.x = read4Bytes(&quot;ColorSpaceBlueX&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L383">            colorSpace.blue.y = read4Bytes(&quot;ColorSpaceBlueY&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L384">            colorSpace.blue.z = read4Bytes(&quot;ColorSpaceBlueZ&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L385">            gammaRed = read4Bytes(&quot;GammaRed&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L386">            gammaGreen = read4Bytes(&quot;GammaGreen&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="fc" id="L387">            gammaBlue = read4Bytes(&quot;GammaBlue&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
        }
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        if (bitmapHeaderSize &gt;= 124) {</span>
            // BITMAPV5HEADER
<span class="nc" id="L391">            intent = read4Bytes(&quot;Intent&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="nc" id="L392">            profileData = read4Bytes(&quot;ProfileData&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="nc" id="L393">            profileSize = read4Bytes(&quot;ProfileSize&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
<span class="nc" id="L394">            reservedV5 = read4Bytes(&quot;Reserved&quot;, is, &quot;Not a Valid BMP File&quot;, getByteOrder());</span>
        }

<span class="pc bpc" id="L397" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L398">            debugNumber(&quot;identifier1&quot;, identifier1, 1);</span>
<span class="nc" id="L399">            debugNumber(&quot;identifier2&quot;, identifier2, 1);</span>
<span class="nc" id="L400">            debugNumber(&quot;fileSize&quot;, fileSize, 4);</span>
<span class="nc" id="L401">            debugNumber(&quot;reserved&quot;, reserved, 4);</span>
<span class="nc" id="L402">            debugNumber(&quot;bitmapDataOffset&quot;, bitmapDataOffset, 4);</span>
<span class="nc" id="L403">            debugNumber(&quot;bitmapHeaderSize&quot;, bitmapHeaderSize, 4);</span>
<span class="nc" id="L404">            debugNumber(&quot;width&quot;, width, 4);</span>
<span class="nc" id="L405">            debugNumber(&quot;height&quot;, height, 4);</span>
<span class="nc" id="L406">            debugNumber(&quot;planes&quot;, planes, 2);</span>
<span class="nc" id="L407">            debugNumber(&quot;bitsPerPixel&quot;, bitsPerPixel, 2);</span>
<span class="nc" id="L408">            debugNumber(&quot;compression&quot;, compression, 4);</span>
<span class="nc" id="L409">            debugNumber(&quot;bitmapDataSize&quot;, bitmapDataSize, 4);</span>
<span class="nc" id="L410">            debugNumber(&quot;hResolution&quot;, hResolution, 4);</span>
<span class="nc" id="L411">            debugNumber(&quot;vResolution&quot;, vResolution, 4);</span>
<span class="nc" id="L412">            debugNumber(&quot;colorsUsed&quot;, colorsUsed, 4);</span>
<span class="nc" id="L413">            debugNumber(&quot;colorsImportant&quot;, colorsImportant, 4);</span>
<span class="nc bnc" id="L414" title="All 4 branches missed.">            if (bitmapHeaderSize &gt;= 52 || compression == BI_BITFIELDS) {</span>
<span class="nc" id="L415">                debugNumber(&quot;redMask&quot;, redMask, 4);</span>
<span class="nc" id="L416">                debugNumber(&quot;greenMask&quot;, greenMask, 4);</span>
<span class="nc" id="L417">                debugNumber(&quot;blueMask&quot;, blueMask, 4);</span>
            }
<span class="nc bnc" id="L419" title="All 2 branches missed.">            if (bitmapHeaderSize &gt;= 56) {</span>
<span class="nc" id="L420">                debugNumber(&quot;alphaMask&quot;, alphaMask, 4);</span>
            }
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (bitmapHeaderSize &gt;= 108) {</span>
<span class="nc" id="L423">                debugNumber(&quot;colorSpaceType&quot;, colorSpaceType, 4);</span>
<span class="nc" id="L424">                debugNumber(&quot;colorSpace.red.x&quot;, colorSpace.red.x, 1);</span>
<span class="nc" id="L425">                debugNumber(&quot;colorSpace.red.y&quot;, colorSpace.red.y, 1);</span>
<span class="nc" id="L426">                debugNumber(&quot;colorSpace.red.z&quot;, colorSpace.red.z, 1);</span>
<span class="nc" id="L427">                debugNumber(&quot;colorSpace.green.x&quot;, colorSpace.green.x, 1);</span>
<span class="nc" id="L428">                debugNumber(&quot;colorSpace.green.y&quot;, colorSpace.green.y, 1);</span>
<span class="nc" id="L429">                debugNumber(&quot;colorSpace.green.z&quot;, colorSpace.green.z, 1);</span>
<span class="nc" id="L430">                debugNumber(&quot;colorSpace.blue.x&quot;, colorSpace.blue.x, 1);</span>
<span class="nc" id="L431">                debugNumber(&quot;colorSpace.blue.y&quot;, colorSpace.blue.y, 1);</span>
<span class="nc" id="L432">                debugNumber(&quot;colorSpace.blue.z&quot;, colorSpace.blue.z, 1);</span>
<span class="nc" id="L433">                debugNumber(&quot;gammaRed&quot;, gammaRed, 4);</span>
<span class="nc" id="L434">                debugNumber(&quot;gammaGreen&quot;, gammaGreen, 4);</span>
<span class="nc" id="L435">                debugNumber(&quot;gammaBlue&quot;, gammaBlue, 4);</span>
            }
<span class="nc bnc" id="L437" title="All 2 branches missed.">            if (bitmapHeaderSize &gt;= 124) {</span>
<span class="nc" id="L438">                debugNumber(&quot;intent&quot;, intent, 4);</span>
<span class="nc" id="L439">                debugNumber(&quot;profileData&quot;, profileData, 4);</span>
<span class="nc" id="L440">                debugNumber(&quot;profileSize&quot;, profileSize, 4);</span>
<span class="nc" id="L441">                debugNumber(&quot;reservedV5&quot;, reservedV5, 4);</span>
            }
        }

<span class="fc" id="L445">        return new BmpHeaderInfo(identifier1, identifier2, fileSize, reserved, bitmapDataOffset, bitmapHeaderSize, width, height, planes, bitsPerPixel,</span>
                compression, bitmapDataSize, hResolution, vResolution, colorsUsed, colorsImportant, redMask, greenMask, blueMask, alphaMask, colorSpaceType,
                colorSpace, gammaRed, gammaGreen, gammaBlue, intent, profileData, profileSize, reservedV5);
    }

    private BmpImageContents readImageContents(final InputStream is, final FormatCompliance formatCompliance) throws ImagingException, IOException {
<span class="fc" id="L451">        final BmpHeaderInfo bhi = readBmpHeaderInfo(is, formatCompliance);</span>

<span class="fc" id="L453">        int colorTableSize = bhi.colorsUsed;</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">        if (colorTableSize == 0) {</span>
<span class="fc" id="L455">            colorTableSize = 1 &lt;&lt; bhi.bitsPerPixel;</span>
        }

<span class="pc bpc" id="L458" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L459">            debugNumber(&quot;ColorsUsed&quot;, bhi.colorsUsed, 4);</span>
<span class="nc" id="L460">            debugNumber(&quot;BitsPerPixel&quot;, bhi.bitsPerPixel, 4);</span>
<span class="nc" id="L461">            debugNumber(&quot;ColorTableSize&quot;, colorTableSize, 4);</span>
<span class="nc" id="L462">            debugNumber(&quot;bhi.colorsUsed&quot;, bhi.colorsUsed, 4);</span>
<span class="nc" id="L463">            debugNumber(&quot;Compression&quot;, bhi.compression, 4);</span>
        }

        // A palette is always valid, even for images that don't need it
        // (like 32 bpp), it specifies the &quot;optimal color palette&quot; for
        // when the image is displayed on a &lt;= 256 color graphics card.
        int paletteLength;
<span class="fc" id="L470">        int rleSamplesPerByte = 0;</span>
<span class="fc" id="L471">        boolean rle = false;</span>

<span class="pc bpc" id="L473" title="1 of 5 branches missed.">        switch (bhi.compression) {</span>
        case BI_RGB:
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">            if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L476">                LOGGER.fine(&quot;Compression: BI_RGB&quot;);</span>
            }
<span class="fc bfc" id="L478" title="All 2 branches covered.">            if (bhi.bitsPerPixel &lt;= 8) {</span>
<span class="fc" id="L479">                paletteLength = 4 * colorTableSize;</span>
            } else {
<span class="fc" id="L481">                paletteLength = 0;</span>
            }
            // BytesPerPaletteEntry = 0;
            // System.out.println(&quot;Compression: BI_RGBx2: &quot; + bhi.BitsPerPixel);
            // System.out.println(&quot;Compression: BI_RGBx2: &quot; + (bhi.BitsPerPixel
            // &lt;= 16));
<span class="fc" id="L487">            break;</span>

        case BI_RLE4:
<span class="pc bpc" id="L490" title="1 of 2 branches missed.">            if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L491">                LOGGER.fine(&quot;Compression: BI_RLE4&quot;);</span>
            }
<span class="fc" id="L493">            paletteLength = 4 * colorTableSize;</span>
<span class="fc" id="L494">            rleSamplesPerByte = 2;</span>
            // ExtraBitsPerPixel = 4;
<span class="fc" id="L496">            rle = true;</span>
            // // BytesPerPixel = 2;
            // // BytesPerPaletteEntry = 0;
<span class="fc" id="L499">            break;</span>
        //
        case BI_RLE8:
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">            if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L503">                LOGGER.fine(&quot;Compression: BI_RLE8&quot;);</span>
            }
<span class="fc" id="L505">            paletteLength = 4 * colorTableSize;</span>
<span class="fc" id="L506">            rleSamplesPerByte = 1;</span>
            // ExtraBitsPerPixel = 8;
<span class="fc" id="L508">            rle = true;</span>
            // BytesPerPixel = 2;
            // BytesPerPaletteEntry = 0;
<span class="fc" id="L511">            break;</span>
        //
        case BI_BITFIELDS:
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">            if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L515">                LOGGER.fine(&quot;Compression: BI_BITFIELDS&quot;);</span>
            }
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">            if (bhi.bitsPerPixel &lt;= 8) {</span>
<span class="nc" id="L518">                paletteLength = 4 * colorTableSize;</span>
            } else {
<span class="fc" id="L520">                paletteLength = 0;</span>
            }
            // BytesPerPixel = 2;
            // BytesPerPaletteEntry = 4;
<span class="fc" id="L524">            break;</span>

        default:
<span class="nc" id="L527">            throw new ImagingException(&quot;BMP: Unknown Compression: &quot; + bhi.compression);</span>
        }

<span class="fc bfc" id="L530" title="All 2 branches covered.">        if (paletteLength &lt; 0) {</span>
<span class="fc" id="L531">            throw new ImagingException(&quot;BMP: Invalid negative palette length: &quot; + paletteLength);</span>
        }

<span class="fc" id="L534">        byte[] colorTable = null;</span>
<span class="fc bfc" id="L535" title="All 2 branches covered.">        if (paletteLength &gt; 0) {</span>
<span class="fc" id="L536">            colorTable = readBytes(&quot;ColorTable&quot;, is, paletteLength, &quot;Not a Valid BMP File&quot;);</span>
        }

<span class="pc bpc" id="L539" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L540">            debugNumber(&quot;paletteLength&quot;, paletteLength, 4);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            LOGGER.fine(&quot;ColorTable: &quot; + (colorTable == null ? &quot;null&quot; : Integer.toString(colorTable.length)));</span>
        }

<span class="fc" id="L544">        int imageLineLength = (bhi.bitsPerPixel * bhi.width + 7) / 8;</span>

<span class="pc bpc" id="L546" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L547">            final int pixelCount = bhi.width * bhi.height;</span>
            // this.debugNumber(&quot;Total BitsPerPixel&quot;,
            // (ExtraBitsPerPixel + bhi.BitsPerPixel), 4);
            // this.debugNumber(&quot;Total Bit Per Line&quot;,
            // ((ExtraBitsPerPixel + bhi.BitsPerPixel) * bhi.Width), 4);
            // this.debugNumber(&quot;ExtraBitsPerPixel&quot;, ExtraBitsPerPixel, 4);
<span class="nc" id="L553">            debugNumber(&quot;bhi.Width&quot;, bhi.width, 4);</span>
<span class="nc" id="L554">            debugNumber(&quot;bhi.Height&quot;, bhi.height, 4);</span>
<span class="nc" id="L555">            debugNumber(&quot;ImageLineLength&quot;, imageLineLength, 4);</span>
            // this.debugNumber(&quot;imageDataSize&quot;, imageDataSize, 4);
<span class="nc" id="L557">            debugNumber(&quot;PixelCount&quot;, pixelCount, 4);</span>
        }
        // int ImageLineLength = BytesPerPixel * bhi.Width;
<span class="fc bfc" id="L560" title="All 2 branches covered.">        while (imageLineLength % 4 != 0) {</span>
<span class="fc" id="L561">            imageLineLength++;</span>
        }

<span class="fc bfc" id="L564" title="All 4 branches covered.">        final int headerSize = BITMAP_FILE_HEADER_SIZE + bhi.bitmapHeaderSize + (bhi.bitmapHeaderSize == 40 &amp;&amp; bhi.compression == BI_BITFIELDS ? 3 * 4 : 0);</span>
<span class="fc" id="L565">        final int expectedDataOffset = headerSize + paletteLength;</span>

<span class="pc bpc" id="L567" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L568">            debugNumber(&quot;bhi.BitmapDataOffset&quot;, bhi.bitmapDataOffset, 4);</span>
<span class="nc" id="L569">            debugNumber(&quot;expectedDataOffset&quot;, expectedDataOffset, 4);</span>
        }
<span class="fc" id="L571">        final int extraBytes = bhi.bitmapDataOffset - expectedDataOffset;</span>
<span class="pc bpc" id="L572" title="1 of 4 branches missed.">        if (extraBytes &lt; 0 || extraBytes &gt; bhi.fileSize) {</span>
<span class="fc" id="L573">            throw new ImagingException(&quot;BMP has invalid image data offset: &quot; + bhi.bitmapDataOffset + &quot; (expected: &quot; + expectedDataOffset + &quot;, paletteLength: &quot;</span>
                    + paletteLength + &quot;, headerSize: &quot; + headerSize + &quot;)&quot;);
        }
<span class="fc bfc" id="L576" title="All 2 branches covered.">        if (extraBytes &gt; 0) {</span>
<span class="fc" id="L577">            readBytes(&quot;BitmapDataOffset&quot;, is, extraBytes, &quot;Not a Valid BMP File&quot;);</span>
        }

<span class="fc" id="L580">        final int imageDataSize = bhi.height * imageLineLength;</span>

<span class="pc bpc" id="L582" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L583">            debugNumber(&quot;imageDataSize&quot;, imageDataSize, 4);</span>
        }

        byte[] imageData;
<span class="fc bfc" id="L587" title="All 2 branches covered.">        if (rle) {</span>
<span class="fc" id="L588">            imageData = getRleBytes(is, rleSamplesPerByte);</span>
        } else {
<span class="fc" id="L590">            imageData = readBytes(&quot;ImageData&quot;, is, imageDataSize, &quot;Not a Valid BMP File&quot;);</span>
        }

<span class="pc bpc" id="L593" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE)) {</span>
<span class="nc" id="L594">            debugNumber(&quot;ImageData.length&quot;, imageData.length, 4);</span>
        }

        AbstractPixelParser abstractPixelParser;

<span class="pc bpc" id="L599" title="1 of 4 branches missed.">        switch (bhi.compression) {</span>
        case BI_RLE4:
        case BI_RLE8:
<span class="fc" id="L602">            abstractPixelParser = new PixelParserRle(bhi, colorTable, imageData);</span>
<span class="fc" id="L603">            break;</span>
        case BI_RGB:
<span class="fc" id="L605">            abstractPixelParser = new PixelParserRgb(bhi, colorTable, imageData);</span>
<span class="fc" id="L606">            break;</span>
        case BI_BITFIELDS:
<span class="fc" id="L608">            abstractPixelParser = new PixelParserBitFields(bhi, colorTable, imageData);</span>
<span class="fc" id="L609">            break;</span>
        default:
<span class="nc" id="L611">            throw new ImagingException(&quot;BMP: Unknown Compression: &quot; + bhi.compression);</span>
        }

<span class="fc" id="L614">        return new BmpImageContents(bhi, colorTable, imageData, abstractPixelParser);</span>
    }

    @Override
    public void writeImage(final BufferedImage src, final OutputStream os, BmpImagingParameters params) throws ImagingException, IOException {
<span class="fc bfc" id="L619" title="All 2 branches covered.">        if (params == null) {</span>
<span class="fc" id="L620">            params = new BmpImagingParameters();</span>
        }
<span class="fc" id="L622">        final PixelDensity pixelDensity = params.getPixelDensity();</span>

<span class="fc" id="L624">        final SimplePalette palette = new PaletteFactory().makeExactRgbPaletteSimple(src, 256);</span>

        BmpWriter writer;
<span class="fc bfc" id="L627" title="All 2 branches covered.">        if (palette == null) {</span>
<span class="fc" id="L628">            writer = new BmpWriterRgb();</span>
        } else {
<span class="fc" id="L630">            writer = new BmpWriterPalette(palette);</span>
        }

<span class="fc" id="L633">        final byte[] imageData = writer.getImageData(src);</span>
<span class="fc" id="L634">        final BinaryOutputStream bos = BinaryOutputStream.littleEndian(os);</span>

        // write BitmapFileHeader
<span class="fc" id="L637">        os.write(0x42); // B, Windows 3.1x, 95, NT, Bitmap</span>
<span class="fc" id="L638">        os.write(0x4d); // M</span>

<span class="fc" id="L640">        final int fileSize = BITMAP_FILE_HEADER_SIZE + BITMAP_INFO_HEADER_SIZE + // header size</span>
<span class="fc" id="L641">                4 * writer.getPaletteSize() + // palette size in bytes</span>
                imageData.length;
<span class="fc" id="L643">        bos.write4Bytes(fileSize);</span>

<span class="fc" id="L645">        bos.write4Bytes(0); // reserved</span>
<span class="fc" id="L646">        bos.write4Bytes(BITMAP_FILE_HEADER_SIZE + BITMAP_INFO_HEADER_SIZE + 4 * writer.getPaletteSize()); // Bitmap Data Offset</span>

<span class="fc" id="L648">        final int width = src.getWidth();</span>
<span class="fc" id="L649">        final int height = src.getHeight();</span>

        // write BitmapInfoHeader
<span class="fc" id="L652">        bos.write4Bytes(BITMAP_INFO_HEADER_SIZE); // Bitmap Info Header Size</span>
<span class="fc" id="L653">        bos.write4Bytes(width); // width</span>
<span class="fc" id="L654">        bos.write4Bytes(height); // height</span>
<span class="fc" id="L655">        bos.write2Bytes(1); // Number of Planes</span>
<span class="fc" id="L656">        bos.write2Bytes(writer.getBitsPerPixel()); // Bits Per Pixel</span>

<span class="fc" id="L658">        bos.write4Bytes(BI_RGB); // Compression</span>
<span class="fc" id="L659">        bos.write4Bytes(imageData.length); // Bitmap Data Size</span>
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">        bos.write4Bytes(pixelDensity != null ? (int) Math.round(pixelDensity.horizontalDensityMetres()) : 0); // HResolution</span>
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">        bos.write4Bytes(pixelDensity != null ? (int) Math.round(pixelDensity.verticalDensityMetres()) : 0); // VResolution</span>
<span class="fc bfc" id="L662" title="All 2 branches covered.">        if (palette == null) {</span>
<span class="fc" id="L663">            bos.write4Bytes(0); // Colors</span>
        } else {
<span class="fc" id="L665">            bos.write4Bytes(palette.length()); // Colors</span>
        }
<span class="fc" id="L667">        bos.write4Bytes(0); // Important Colors</span>
        // bos.write_4_bytes(0); // Compression

        // write Palette
<span class="fc" id="L671">        writer.writePalette(bos);</span>
        // write Image Data
<span class="fc" id="L673">        bos.write(imageData);</span>
<span class="fc" id="L674">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>